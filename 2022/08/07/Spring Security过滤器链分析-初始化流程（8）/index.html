<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Spring Security过滤器链分析-初始化流程（8） | 清河水温龙井茶</title><meta name="author" content="李文若"><meta name="copyright" content="李文若"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="过滤器链分析  提起Spring Security的实现原理，很多读者都会想到过滤器链。因为Spring Security中的所有功能都是通过过滤器来实现的，这些过滤器组成一个完整的过滤器链。那么，这些过滤器 链是如何初始化的？我们前面反复提到的AuthenticationManager又是如何初始化的？通过前面章节的学习，相信读者己经有了一些认识，本章我们将从头开始，分析Spring Secur"><meta property="og:type" content="article"><meta property="og:title" content="Spring Security过滤器链分析-初始化流程（8）"><meta property="og:url" content="http://blog.buretuzi.online/2022/08/07/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89/index.html"><meta property="og:site_name" content="清河水温龙井茶"><meta property="og:description" content="过滤器链分析  提起Spring Security的实现原理，很多读者都会想到过滤器链。因为Spring Security中的所有功能都是通过过滤器来实现的，这些过滤器组成一个完整的过滤器链。那么，这些过滤器 链是如何初始化的？我们前面反复提到的AuthenticationManager又是如何初始化的？通过前面章节的学习，相信读者己经有了一些认识，本章我们将从头开始，分析Spring Secur"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://image.buretuzi.online/blog/article/article-background/wallhaven-gp8pdq.jpg"><meta property="article:published_time" content="2022-08-07T16:34:00.000Z"><meta property="article:modified_time" content="2025-05-13T09:14:30.669Z"><meta property="article:author" content="李文若"><meta property="article:tag" content="Spring Security"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image.buretuzi.online/blog/article/article-background/wallhaven-gp8pdq.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.buretuzi.online/2022/08/07/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/pluginsSrc/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"top-right"},source:{justifiedGallery:{js:"/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js",css:"/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Spring Security过滤器链分析-初始化流程（8）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-05-13 09:14:30"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/mouseMove.css"><link rel="stylesheet" href="/css/navigation.css"><link rel="stylesheet" href="/css/Scrollbar.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/rightmenu.css"><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/Progressbar.css"><link rel="stylesheet" href="/css/footer.css"><link rel="stylesheet" href="/css/footerIcon/iconfont.css"><script rel="stylesheet" href="/css/footerIcon/iconfont.js"></script><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/doublecolumn.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/player/aplayer.css"><link rel="stylesheet" href="/css/leftMenu.css"><link rel="stylesheet" href="/css/twikoo_beautify.css"><link rel="stylesheet" href="/css/about.css"><script defer charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script defer src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script><script defer src="/js/51La.js"></script><link rel="stylesheet" href="/css/categorybar.css"><link rel="stylesheet" href="https://image.buretuzi.online/blog/article/document/clock.min.css"><link rel="stylesheet" href="https://image.buretuzi.online/blog/article/document/runtime.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/css/swiper/swiper.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/css/swiper/swiperstyle.css" media="print" onload='this.media="all"'><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",(()=>{preloader.endLoading()})),document.addEventListener("pjax:send",(()=>{preloader.initLoading()})),document.addEventListener("pjax:complete",(()=>{preloader.endLoading()}))</script><link rel="stylesheet" href="/css/Progressbar.css"><script src="/pluginsSrc/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">48</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i> <span>日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i> <span>菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i> <span>关于</span></a></li><li><a class="site-page child" href="/myself/"><i class="fa-fw fa fa-id-card"></i> <span>关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/luaby"><i class="fa-fw fa fa-heart"></i> <span>butterfly</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><div class="back-home-button" tabindex="-1"><i class="back-home-button-icon fas fa-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://www.cnblogs.com/liwenruo/" title="前往博客主页" target="_blank" one-link-mark="yes"><img class="back-menu-item-icon" src="data:image/png;base64,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"><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" href="http://buretuzi.online" rel="external nofollow" title="前往云盘主页" target="_blank" one-link-mark="yes"><img class="back-menu-item-icon" src="data:image/png;base64,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"><span class="back-menu-item-text">我的社区</span></a></div></div></div></div><a id="site-name" href="/"><div class="title">清河水温龙井茶</div><i class="fa-solid fa-house"></i></a></span><div class="mask-name-container"><center id="name-container"><a id="page-name" href="javascript:rmf.scrollToTop()">PAGE_NAME</a></center></div><div id="menus"><div class="nav-button" id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" type="button" title="切换背景" onclick="toggleWinbox()"><i class="fas fa-image"></i></a></div><div class="nav-button" id="darkmode_navswitch"><a class="darkmode_switchbutton" type="button" title="浅色和深色模式转换" onclick="rmf.switchDarkMode()"><i class="fas fa-adjust"></i></a></div><div class="nav-button" id="nav-totop"><a class="totopbtn"><i class="fas fa-arrow-up"></i><span id="percent" onclick="btf.scrollToDest(0,500)">0</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i> <span>日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i> <span>菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i> <span>关于</span></a></li><li><a class="site-page child" href="/myself/"><i class="fa-fw fa fa-id-card"></i> <span>关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/luaby"><i class="fa-fw fa fa-heart"></i> <span>butterfly</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Spring Security过滤器链分析-初始化流程（8）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-07T16:34:00.000Z" title="发表于 2022-08-07 16:34:00">2022-08-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-13T09:14:30.669Z" title="更新于 2025-05-13 09:14:30">2025-05-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>60分钟</span></span><span class="post-meta-separator">|</span><span data-flag-title="Spring Security过滤器链分析-初始化流程（8）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="过滤器链分析"><a href="#过滤器链分析" class="headerlink" title="过滤器链分析"></a>过滤器链分析</h1><p>  提起Spring Security的实现原理，很多读者都会想到过滤器链。因为Spring Security中的所有功能都是通过过滤器来实现的，这些过滤器组成一个完整的过滤器链。那么，这些过滤器 链是如何初始化的？我们前面反复提到的AuthenticationManager又是如何初始化的？通过前面章节的学习，相信读者己经有了一些认识，本章我们将从头开始，分析Spring Security的初始化流程，同时再通过六个案例来让读者深入理解并且学会如何制作过滤器链。由于初始化流程相对复杂，因此我们没有选择在一开始就讲解Spring Security初始化流程，而是放到本节。当读者对于Spring Security有一个基本的认知之后再来讲解，此时相对来说就会比较容易理解。</p><p>本章涉及的主要知识点有：</p><ul><li>初始化流程分析。</li><li>ObjectPostProcessor 的使用。</li><li>多种用户定义方式。</li><li>定义多个过滤器链。</li><li>静态资源过滤。</li><li>使用JSON格式登录。</li><li>添加登录验证码。</li></ul><h1 id="1-初始化流程分析"><a href="#1-初始化流程分析" class="headerlink" title="1. 初始化流程分析"></a>1. 初始化流程分析</h1><p>  Spring Security初始化流程整体上来说理解起来并不难,但是这里涉及许多零碎的知识点， 把这些零碎的知识点搞懂了，再来梳理初始化流程就会容易很多。因此，这里先介绍一下SpringSecurity中一些常见的关键组件，在理解这些组件的基础上，再来分析初始化流程，就能加深对其的理解。</p><h2 id="1-1-ObjectPostProcessor"><a href="#1-1-ObjectPostProcessor" class="headerlink" title="1.1 ObjectPostProcessor"></a>1.1 ObjectPostProcessor</h2><p>  ObjectPostProcessor是Spring Security中使用频率最高的组件之一，它是一个对象后置处理器，也就是当一个对象创建成功后，如果还有一些额外的事情需要补充，那么可以通过 ObjectPostProcessor来进行处理。这个接口中默认只有一个方法postProcess,该方法用来完成对对象的二次处理，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ObjectPostProcessor</span>&lt;T&gt; &#123;</span><br><span class="line">	&lt;O <span class="keyword">extends</span> <span class="title class_">T</span>&gt; O <span class="title function_">postProcess</span><span class="params">(O object)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  ObjectPostProcessor默认有两个继承类，如图4-1所示。</p><p>  <img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%881%EF%BC%89.png"></p><center>图 4-1</center><ul><li>AutowireBeanFactoryObjectPostProcessor:由于 Spring Security 中大量采用了 Java 配置， 许多过滤器都是直接new出来的，这些直接new出来的对象并不会自动注入到Spring 容器中。Spring Security这样做的本意是为了简化配置，但是却带来了另外一个问题就是, 大量new出来的对象需要我们手动注册到Spring客器中去。AutowireBeanFactoryObjectPostProcessor对象所承担的就是这件事，一个对象new出来之后，只要调用 AutowireBeanFactoryObjectPostProcessor.postProcess 方法，就可以成功注入到 Spring 容器中，它的实现原理就是通过调用Spring容器中的AutowireCapableBeanFactory对象将一个new出来的对象注入到Spring容器中去。</li><li>CompositeObjectPostProcessor:这是ObjectPostProcessor 的另一个实现，一个对象可以有一个后置处理器，开发者也可以自定义多个对象后置处理器。 CompositeObjectPostProcessor是一个组合的对象后置处理器,它里边维护了一个List集合，集合中存放了某一个对象的所有后置处理器，当需要执行对象的后置处理器时，会遍历集合中的所有ObjectPostProcessor实例，分别调用实例的postProcess方法进行对象后置处理。在Spring Security框架中，最终使用的对象后置处理器其实就是 CompositeObjectPostProcessor ,它里边的集合默认只有一个对象，就是 AutowireBeanFactoryObjectPostProcessor。</li></ul><p>  在Spring Security中，开发者可以灵活地配置项目中需要哪些Spring Security过滤器，一 旦选定过滤器之后，每一个过滤器都会有一个对应的配置器，叫作xxxConfigurer (例如CorsConfigurer. CsrfConfigurer等)，过滤器都是在 xxxConfigurer 中 new 出来的，然后在 postProcess方法中处理一遍，就将这些过滤器注入到Spring容器中了。这是对象后置处理器ObjectPostProcessor的主要作用。</p><h2 id="1-2-SecurityFilterChain"><a href="#1-2-SecurityFilterChain" class="headerlink" title="1.2 SecurityFilterChain"></a>1.2 SecurityFilterChain</h2><p>从名称上可以看出，SecurityFilterChain就是Spring Security中的过滤器链对象。下面来看一下 SecurityFilterChain的源码：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityFilterChain</span> &#123;</span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(httpsServletRequest request)</span>;</span><br><span class="line">	List&lt;Filter&gt; <span class="title function_">getFilters</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，SecurityFilterChain中有两个方法：</p><ul><li>matches:该方法用来判断request请求是否应该被当前过滤器链所处理心</li><li>getFilters：该方法返回一个List集合，集合中存放的就是Spring Security中的过滤器。换言之，如果matches方法返回true,那么request请求就会在getFilters方法所返回的Filter 集合中被处理。</li></ul><p>SecurityFilterChain只有一个默认的实现类就是DefaultSecurityFilterChain，其中定义了两 个属性，并具体实现了 SecurityFilterChain中的两个方法：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DefaultSecurityFilterChain</span> <span class="keyword">implements</span> <span class="title class_">SecurityFilterChain</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(DefaultSecurityFilterChain.class);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RequestMatcher requestMatcher;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;Filter&gt; filters;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">DefaultSecurityFilterChain</span><span class="params">(RequestMatcher requestMatcher, Filter... filters)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>(requestMatcher, Arrays.asList(filters));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">DefaultSecurityFilterChain</span><span class="params">(RequestMatcher requestMatcher, List&lt;Filter&gt; filters)</span> &#123;</span><br><span class="line">		logger.info(<span class="string">&quot;Creating filter chain: &quot;</span> + requestMatcher + <span class="string">&quot;, &quot;</span> + filters);</span><br><span class="line">		<span class="built_in">this</span>.requestMatcher = requestMatcher;</span><br><span class="line">		<span class="built_in">this</span>.filters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(filters);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> RequestMatcher <span class="title function_">getRequestMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestMatcher;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> List&lt;Filter&gt; <span class="title function_">getFilters</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> filters;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(httpsServletRequest request)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestMatcher.matches(request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;[ &quot;</span> + requestMatcher + <span class="string">&quot;, &quot;</span> + filters + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以看到，在DefaultSecurityFilterChain的构造方法中，需要传入两个对象，一个是请求 匹配器requestMatcher,另一个则是过滤器集合或者过滤器数组filters。这个实现类比较简单, 这里就不再赘述了。</p><p>  需要注意的是，在一个Spring Security项目中，SecurityFilterChain的实例可能会有多个，在后面的小节中会详细分析，并演示多个SecurityFilterChain实例的情况。</p><h2 id="1-3-SecurityBuilder"><a href="#1-3-SecurityBuilder" class="headerlink" title="1.3 SecurityBuilder"></a>1.3 SecurityBuilder</h2><p>Spring Security中所有需要构建的对象都可以通过SecurityBuilder来实现，默认的过滤器 链、代理过滤器AuthenticationManager 等，都可以通过 SecurityBuilder来构建。SecurityBuilder的实现类如图4-2所示。</p><p>  <img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%882%EF%BC%89.png"></p><center>图 4-2</center><p>  SecurityBuilder：</p><p>  我们先来看SecurityBuilder的源码：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt; &#123;</span><br><span class="line">	O <span class="title function_">build</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  由上述代码可以看到，SecurityBuilder中只有一个build方法，就是对象构建方法。build 方法的返回值，就是具体构建的对象泛型O,也就是说不同的SecurityBuilder将来会构建出不同的对象。</p><p>  httpsSecurityBuiIder：</p><p>  httpsSecurityBuilder是用来构建 httpsSecurity对象的，httpsSecurityBuilder 的定义如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">httpsSecurityBuilder</span>&lt;H <span class="keyword">extends</span> <span class="title class_">httpsSecurityBuilder</span>&lt;H&gt;&gt; <span class="keyword">extends</span></span><br><span class="line">		<span class="title class_">SecurityBuilder</span>&lt;DefaultSecurityFilterChain&gt; &#123;</span><br><span class="line">	&lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;DefaultSecurityFilterChain, H&gt;&gt; C <span class="title function_">getConfigurer</span><span class="params">(</span></span><br><span class="line"><span class="params">			Class&lt;C&gt; clazz)</span>;</span><br><span class="line">    </span><br><span class="line">	&lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;DefaultSecurityFilterChain, H&gt;&gt; C <span class="title function_">removeConfigurer</span><span class="params">(</span></span><br><span class="line"><span class="params">			Class&lt;C&gt; clazz)</span>;</span><br><span class="line">	</span><br><span class="line">	&lt;C&gt; <span class="keyword">void</span> <span class="title function_">setSharedObject</span><span class="params">(Class&lt;C&gt; sharedType, C object)</span>;</span><br><span class="line">	</span><br><span class="line">	&lt;C&gt; C <span class="title function_">getSharedObject</span><span class="params">(Class&lt;C&gt; sharedType)</span>;</span><br><span class="line">	</span><br><span class="line">	H <span class="title function_">authenticationProvider</span><span class="params">(AuthenticationProvider authenticationProvider)</span>;</span><br><span class="line">	</span><br><span class="line">	H <span class="title function_">userDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">	</span><br><span class="line">	H <span class="title function_">addFilterAfter</span><span class="params">(Filter filter, Class&lt;? extends Filter&gt; afterFilter)</span>;</span><br><span class="line">	</span><br><span class="line">	H <span class="title function_">addFilterBefore</span><span class="params">(Filter filter, Class&lt;? extends Filter&gt; beforeFilter)</span>;</span><br><span class="line">	</span><br><span class="line">	H <span class="title function_">addFilter</span><span class="params">(Filter filter)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们简单分析一下这段源码：</p><ul><li>httpsSecurityBuilder对象本身在定义时就有一个泛型，这个泛型是httpsSecurityBuilder 的子类，由于默认情况下httpsSecurityBuilder的实现类只有一个httpsSecurity，所以可以暂且把接口中的H都当成httpsSecurity来理解。</li><li>httpsSecurityBuilder 继承自 SecurityBuilder 接口，同时也指定了 SecurityBuilder 中的泛型为DefaultSecurityFilterChain,也就是说，httpsSecurityBuilder最终想要构建的对象是 DefaultSecurityFilterChain。</li><li>getConfigurer方法用来获取一个配置器，所谓的配置器就是xxxConfigurer，我们将在下一小节中详细介绍配置器，</li><li>removeConfigurer方法用来移除一个配置器(相当于从Spring Security过滤器链中移 除一个过滤器)。</li><li>setSharedObject&#x2F;getSharedObject这两个方法用来设置或者获取一个可以在多个配置器之间共享的对象。</li><li>authenticationProvider 方法可以用来配置一个认证器 AuthenticationProvider。</li><li>userDetailsService 方法可以用来配置一个数据源 UserDetailsService。</li><li>addFilterAfter&#x2F;addFilterBefore方法表示在某一个过滤器之后或者之前添加一个自定义的过滤器。</li><li>addFilter方法可以添加一个过滤器，这个过滤器必须是Spring Security框架提供的 过滤器的一个实例或者其扩展，添加完成后，会自动进行过滤器的排序。</li></ul><p>AbstractSecurityBuilder：</p><p>  AbstractSecurityBuilder实现了 SecurityBuilder 接口，并对 build 做了完善，确保只 build 一次。我们来看—下 AbstractSecurityBuilder 源码:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractSecurityBuilder</span>&lt;O&gt; <span class="keyword">implements</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">AtomicBoolean</span> <span class="variable">building</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> O object;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> O <span class="title function_">build</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.building.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">			<span class="built_in">this</span>.object = doBuild();</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.object;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AlreadyBuiltException</span>(<span class="string">&quot;This object has already been built&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> O <span class="title function_">getObject</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.building.get()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This object has not been built&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.object;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> O <span class="title function_">doBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由上述代码可以看到，在AbstractSecurityBuilder类中:</p><ul><li>首先声明了 building变量，可以确保即使在多线程环境下，配置类也只构建一次。</li><li>对build方法进行重写，并II设置为final,这样在AbstractSecurityBuilder的了类中 将不能再次重写build方法，在build方法内部，通过building变量来控制配置类只构建一次, 具体的构建工作则交给doBuild方法去完成。</li><li>getObject方法用来返回构建的对象。</li><li>doBuild方法则是具体的构建方法，该方法在AbstractSecurityBuilder中是一个抽象方法，具体的实现在其子类中。</li></ul><p>一言以蔽之，AbstractSecurityBuilder的作用是确保目标对象只被构建一次。</p><p>  AbstractConfiguredSecurityBuilder：</p><p>  AbstractConfiguredSecurityBuilder类的源码就稍微长一点，我们分别来看，首先在AbstractConfiguredSecurityBuilder中声明了一个枚举类，用来描述构建过程的不同状态：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">BuildState</span> &#123;</span><br><span class="line">    UNBUILT(<span class="number">0</span>),</span><br><span class="line">    INITIALIZING(<span class="number">1</span>),</span><br><span class="line">    CONFIGURING(<span class="number">2</span>),</span><br><span class="line">    BUILDING(<span class="number">3</span>),</span><br><span class="line">    BUILT(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> order;</span><br><span class="line">    BuildState(<span class="type">int</span> order) &#123;</span><br><span class="line">        <span class="built_in">this</span>.order = order;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isInitializing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INITIALIZING.order == order;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isConfigured</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> order &gt;= CONFIGURING.order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，整个构建过程一共有五种不同的状态：</p><ul><li>UNBUILT：配置类构建前。</li><li>INITIALIZING：初始化中(初始化完成之前是这个状态)。</li><li>CONFIGURING：配置中(开始构建之前是这个状态)。</li><li>BUILDING：构建中。</li><li>BUILT：构建完成。</li></ul><p>这个枚举类里边还提供了两个判断方法 islnitializing 表示是否正在初始化中, isConfigured 方法表示是否已完成配置。</p><p>AbstractConfiguredSecurityBuilder中还声明了 configurers变量，用来保存所有的配置类。针对configurers变量，我们可以进行添加配置、移除配置等操作，相关方法如下：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;O, B <span class="keyword">extends</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt;&gt;</span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">AbstractSecurityBuilder</span>&lt;O&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(getClass());</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> LinkedHashMap&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;, List&lt;SecurityConfigurer&lt;O, B&gt;&gt;&gt; configurers = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;, List&lt;SecurityConfigurer&lt;O, B&gt;&gt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurersAddedInInitializing = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SecurityConfigurer&lt;O, B&gt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt;, Object&gt; sharedObjects = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt;, Object&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> allowConfigurersOfSameType;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">BuildState</span> <span class="variable">buildState</span> <span class="operator">=</span> BuildState.UNBUILT;</span><br><span class="line">	<span class="keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectPostProcessor;</span><br><span class="line">	<span class="keyword">protected</span> <span class="title function_">AbstractConfiguredSecurityBuilder</span><span class="params">(</span></span><br><span class="line"><span class="params">			ObjectPostProcessor&lt;Object&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>(objectPostProcessor, <span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">protected</span> <span class="title function_">AbstractConfiguredSecurityBuilder</span><span class="params">(</span></span><br><span class="line"><span class="params">			ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span></span><br><span class="line"><span class="params">			<span class="type">boolean</span> allowConfigurersOfSameType)</span> &#123;</span><br><span class="line">		Assert.notNull(objectPostProcessor, <span class="string">&quot;objectPostProcessor cannot be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.objectPostProcessor = objectPostProcessor;</span><br><span class="line">		<span class="built_in">this</span>.allowConfigurersOfSameType = allowConfigurersOfSameType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> O <span class="title function_">getOrBuild</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (isUnbuilt()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> build();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Failed to perform build. Returning null&quot;</span>, e);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> getObject();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;O, B&gt;&gt; C <span class="title function_">apply</span><span class="params">(C configurer)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		configurer.addObjectPostProcessor(objectPostProcessor);</span><br><span class="line">		configurer.setBuilder((B) <span class="built_in">this</span>);</span><br><span class="line">		add(configurer);</span><br><span class="line">		<span class="keyword">return</span> configurer;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="title function_">apply</span><span class="params">(C configurer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		add(configurer);</span><br><span class="line">		<span class="keyword">return</span> configurer;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C&gt; <span class="keyword">void</span> <span class="title function_">setSharedObject</span><span class="params">(Class&lt;C&gt; sharedType, C object)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.sharedObjects.put(sharedType, object);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C&gt; C <span class="title function_">getSharedObject</span><span class="params">(Class&lt;C&gt; sharedType)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (C) <span class="built_in">this</span>.sharedObjects.get(sharedType);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt;, Object&gt; getSharedObjects() &#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.unmodifiableMap(<span class="built_in">this</span>.sharedObjects);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(C configurer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		Assert.notNull(configurer, <span class="string">&quot;configurer cannot be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">		Class&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; clazz = (Class&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;) configurer</span><br><span class="line">				.getClass();</span><br><span class="line">		<span class="keyword">synchronized</span> (configurers) &#123;</span><br><span class="line">			<span class="keyword">if</span> (buildState.isConfigured()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot apply &quot;</span> + configurer</span><br><span class="line">						+ <span class="string">&quot; to already built object&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = allowConfigurersOfSameType ? <span class="built_in">this</span>.configurers</span><br><span class="line">					.get(clazz) : <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">				configs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SecurityConfigurer&lt;O, B&gt;&gt;(<span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			configs.add(configurer);</span><br><span class="line">			<span class="built_in">this</span>.configurers.put(clazz, configs);</span><br><span class="line">			<span class="keyword">if</span> (buildState.isInitializing()) &#123;</span><br><span class="line">				<span class="built_in">this</span>.configurersAddedInInitializing.add(configurer);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; List&lt;C&gt; <span class="title function_">getConfigurers</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;C&gt; configs = (List&lt;C&gt;) <span class="built_in">this</span>.configurers.get(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(configs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; List&lt;C&gt; <span class="title function_">removeConfigurers</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;C&gt; configs = (List&lt;C&gt;) <span class="built_in">this</span>.configurers.remove(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(configs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="title function_">getConfigurer</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="built_in">this</span>.configurers.get(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (configs.size() != <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Only one configurer expected for type &quot;</span></span><br><span class="line">					+ clazz + <span class="string">&quot;, but got &quot;</span> + configs);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (C) configs.get(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt; C <span class="title function_">removeConfigurer</span><span class="params">(Class&lt;C&gt; clazz)</span> &#123;</span><br><span class="line">		List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs = <span class="built_in">this</span>.configurers.remove(clazz);</span><br><span class="line">		<span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (configs.size() != <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Only one configurer expected for type &quot;</span></span><br><span class="line">					+ clazz + <span class="string">&quot;, but got &quot;</span> + configs);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (C) configs.get(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> O <span class="title function_">objectPostProcessor</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		Assert.notNull(objectPostProcessor, <span class="string">&quot;objectPostProcessor cannot be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.objectPostProcessor = objectPostProcessor;</span><br><span class="line">		<span class="keyword">return</span> (O) <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">protected</span> &lt;P&gt; P <span class="title function_">postProcess</span><span class="params">(P object)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.objectPostProcessor.postProcess(object);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们解析一下这段源码：</p><ul><li>首先声明了一个configurers变量，用来保存所有的配置类，key是配置类Class对象, 值是一个List集合中放着配置类。</li><li>apply方法有两个，参数类型略有差异，主要功能基本一致，都是向configurers变量中添加配置类，具体的添加过程则是调用add方法。</li><li>add方法用来将所有的配置类保存到configurers中，在添加的过程中，如果 allowConfigurersOfSameType变量为true，则表示允许相同类型的配置类存在，也就是List集合中可以存在多个相同类型的配置类。默认情况下，如果是普通配置类， allowConfigurersOfSameType是false，所以List集合中的配置类始终只有一个配置类；如果在 AuthenticationManagerBuilder 中设置 allowConfigurersOfSameType 为 true,此时相同类型的配置类可以有多个(下文会详细分析AuthenticationManagerBuilder)。</li><li>getConfigurers(Class<c>)方法可以从configurers中返回某一个配置类对应的所有实例</c></li><li>removeConfigurers方法可以从configurers中移除某一个配置类对应的所有实例，并返回被移除掉的配置类实例集合，</li><li>getConfigurer方法也是获取配置类实例，但是只获取集合中第一项。</li><li>removeConfigurer方法可以从configurers中移除某一个配置类对应的所有配置类实例，并返回被移除掉的配置类实例中的第一项。</li><li>getConfigurers方法是一个私有方法，主要是把所有的配置类实例放到一个集合中返 回.在配置类初始化和配置的时候，会调用到该方法，</li></ul><p>这些就是 AbstractConfiguredSecurityBuilder 中关于 configurers 的所有操作。</p><p>接下来就是AbstractConfiguredSecurityBuilder中的doBuild方法了，这是核心的构建方法。</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> O <span class="title function_">doBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (configurers) &#123;</span><br><span class="line">        buildState = BuildState.INITIALIZING;</span><br><span class="line">        beforeInit();</span><br><span class="line">        init();</span><br><span class="line">        buildState = BuildState.CONFIGURING;</span><br><span class="line">        beforeConfigure();</span><br><span class="line">        configure();</span><br><span class="line">        buildState = BuildState.BUILDING;</span><br><span class="line">        <span class="type">O</span> <span class="variable">result</span> <span class="operator">=</span> performBuild();</span><br><span class="line">        buildState = BuildState.BUILT;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeInit</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeConfigure</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> O <span class="title function_">performBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = getConfigurers();</span><br><span class="line">    <span class="keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : configurers) &#123;</span><br><span class="line">        configurer.init((B) <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : configurersAddedInInitializing) &#123;</span><br><span class="line">        configurer.init((B) <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = getConfigurers();</span><br><span class="line">    <span class="keyword">for</span> (SecurityConfigurer&lt;O, B&gt; configurer : configurers) &#123;</span><br><span class="line">        configurer.configure((B) <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; <span class="title function_">getConfigurers</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;SecurityConfigurer&lt;O, B&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SecurityConfigurer&lt;O, B&gt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configs : <span class="built_in">this</span>.configurers.values()) &#123;</span><br><span class="line">        result.addAll(configs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isUnbuilt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (configurers) &#123;</span><br><span class="line">        <span class="keyword">return</span> buildState == BuildState.UNBUILT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>在doBuild方法中，一边更新构建状态，一边执行构建方法由构建方法中,beforeInit 是一个空的初始化方法，如果需要在初始化之前做一些准备工作，可以通过重写该方法实现,</p></li><li><p>init方法是所有配置类的初始化方法，在该方法中，遍历所有的配置类，并调用其 init方法完成初始化操作。</p></li><li><p>beforeConfigure方法可以在configure方法执行之前做一些准备操作心该方法默认也是一个空方法，</p></li><li><p>configure方法用来完成所有配置类的配置，在configure方法中，遍历所有的配置类,分别调用其configure方法完成配置。</p></li><li><p>performBuild方法用来做最终的构建操作，前面的准备工作完成后，最后在 performBuild方法中完成构建，这是一个抽象方法，具体的实现则在不同的配置类中。</p><p>这些就是AbstractConfiguredSecurityBuilder中最主要的几个方法，其他一些方法比较简单，这里就不一一赘述了</p></li></ul><p>ProviderManagerBuilder：</p><p>  ProviderManagerBuilder继承自 SecurityBuilder接口，并制定了构建的对象是 AuthenticationManager, 代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProviderManagerBuilder</span>&lt;B <span class="keyword">extends</span> <span class="title class_">ProviderManagerBuilder</span>&lt;B&gt;&gt; <span class="keyword">extends</span></span><br><span class="line">		<span class="title class_">SecurityBuilder</span>&lt;AuthenticationManager&gt; &#123;</span><br><span class="line">	B <span class="title function_">authenticationProvider</span><span class="params">(AuthenticationProvider authenticationProvider)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以看到，ProviderManagerBuilder 中增加 了一个 authenticationProvider 方法，同时通过泛型指定了构建的对象为AuthenticationManager。</p><p>AuthenticationManagerBuilder：</p><p>AuthenticationManagerBuilder 用来构建 AuthenticationManager 对象，它继承自 AbstractConfiguredSecurityBuilder,并且实现了 ProviderManagerBuilder接口，源码比较长，我们截取部分常用代码，代码如下：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationManagerBuilder</span></span><br><span class="line">		<span class="keyword">extends</span></span><br><span class="line">		<span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;AuthenticationManager, AuthenticationManagerBuilder&gt;</span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">ProviderManagerBuilder</span>&lt;AuthenticationManagerBuilder&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(getClass());</span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager parentAuthenticationManager;</span><br><span class="line">	<span class="keyword">private</span> List&lt;AuthenticationProvider&gt; authenticationProviders = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> UserDetailsService defaultUserDetailsService;</span><br><span class="line">	<span class="keyword">private</span> Boolean eraseCredentials;</span><br><span class="line">	<span class="keyword">private</span> AuthenticationEventPublisher eventPublisher;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">AuthenticationManagerBuilder</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(objectPostProcessor, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">parentAuthenticationManager</span><span class="params">(</span></span><br><span class="line"><span class="params">			AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (authenticationManager <span class="keyword">instanceof</span> ProviderManager) &#123;</span><br><span class="line">			eraseCredentials(((ProviderManager) authenticationManager)</span><br><span class="line">					.isEraseCredentialsAfterAuthentication());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.parentAuthenticationManager = authenticationManager;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">authenticationEventPublisher</span><span class="params">(</span></span><br><span class="line"><span class="params">			AuthenticationEventPublisher eventPublisher)</span> &#123;</span><br><span class="line">		Assert.notNull(eventPublisher, <span class="string">&quot;AuthenticationEventPublisher cannot be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.eventPublisher = eventPublisher;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">eraseCredentials</span><span class="params">(<span class="type">boolean</span> eraseCredentials)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.eraseCredentials = eraseCredentials;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> InMemoryUserDetailsManagerConfigurer&lt;AuthenticationManagerBuilder&gt; <span class="title function_">inMemoryAuthentication</span><span class="params">()</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> apply(<span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManagerConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> JdbcUserDetailsManagerConfigurer&lt;AuthenticationManagerBuilder&gt; <span class="title function_">jdbcAuthentication</span><span class="params">()</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> apply(<span class="keyword">new</span> <span class="title class_">JdbcUserDetailsManagerConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">UserDetailsService</span>&gt; DaoAuthenticationConfigurer&lt;AuthenticationManagerBuilder, T&gt; <span class="title function_">userDetailsService</span><span class="params">(</span></span><br><span class="line"><span class="params">			T userDetailsService)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="built_in">this</span>.defaultUserDetailsService = userDetailsService;</span><br><span class="line">		<span class="keyword">return</span> apply(<span class="keyword">new</span> <span class="title class_">DaoAuthenticationConfigurer</span>&lt;&gt;(</span><br><span class="line">				userDetailsService));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> LdapAuthenticationProviderConfigurer&lt;AuthenticationManagerBuilder&gt; <span class="title function_">ldapAuthentication</span><span class="params">()</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> apply(<span class="keyword">new</span> <span class="title class_">LdapAuthenticationProviderConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">authenticationProvider</span><span class="params">(</span></span><br><span class="line"><span class="params">			AuthenticationProvider authenticationProvider)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.authenticationProviders.add(authenticationProvider);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> ProviderManager <span class="title function_">performBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isConfigured()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;No authenticationProviders and no parentAuthenticationManager defined. Returning null.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">ProviderManager</span> <span class="variable">providerManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderManager</span>(authenticationProviders,</span><br><span class="line">				parentAuthenticationManager);</span><br><span class="line">		<span class="keyword">if</span> (eraseCredentials != <span class="literal">null</span>) &#123;</span><br><span class="line">			providerManager.setEraseCredentialsAfterAuthentication(eraseCredentials);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (eventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">			providerManager.setAuthenticationEventPublisher(eventPublisher);</span><br><span class="line">		&#125;</span><br><span class="line">		providerManager = postProcess(providerManager);</span><br><span class="line">		<span class="keyword">return</span> providerManager;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isConfigured</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> !authenticationProviders.isEmpty() || parentAuthenticationManager != <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> UserDetailsService <span class="title function_">getDefaultUserDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.defaultUserDetailsService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> &lt;C <span class="keyword">extends</span> <span class="title class_">UserDetailsAwareConfigurer</span>&lt;AuthenticationManagerBuilder, ? <span class="keyword">extends</span> <span class="title class_">UserDetailsService</span>&gt;&gt; C <span class="title function_">apply</span><span class="params">(</span></span><br><span class="line"><span class="params">			C configurer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="built_in">this</span>.defaultUserDetailsService = configurer.getUserDetailsService();</span><br><span class="line">		<span class="keyword">return</span> (C) <span class="built_in">super</span>.apply(configurer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>首先在AuthenticationManagerBuilder的构造方法中，调用了父类的构造方法，注意第二个参数传递了true,表示允许相同类型的配置类同时存在(结合 AbstractConfiguredSecurityBuilder 的源码来理解)</li><li>parentAuthenticationManager 方法用来给一个 AuthenticationManager 设置 parents</li><li>inMemoryAuthentication方法用来配置基于内存的数据源，该方法会自动创建 InMemoryUserDetailsManagerConfigurer配置类，并最终将该配置类添加到父类的configurers 变量中。由于设置了允许相同类型的配置类同时存在，因此inMemoryAuthentication方法可以反复调用多次</li><li>jdbcAuthentication 以及 userDetailsService 方法与 inMemoryAuthentication 方法类似, 也是用来配置数据源的，这里不再赘述。</li><li>authenticationProvider 方法用来向 authenticationProviders 集合中添加 AuthenticationProvider对象，根据前面第3节的介绍，我们己经知道一个AuthenticationManager实例中包含多个 AuthenticationProvider 实例，那么多个 AuthenticationProvider 实例可以通过 authenticationProvider方法进行添加。</li><li>performBuild方法则执行具体的构建工作，常用的AuthenticationManager实例就是 ProviderManager，所以这里创建 ProviderManager 对象，并旦配置 authenticationProviders 和 parentAuthenticationManager对象，ProviderManager对象创建成功之后，再去对象后置处理器中处理一遍再返回。</li></ul><p>这就是AuthenticationManagerBuilder中的一个大致逻辑。</p><p>httpsSecurity：</p><p>  httpsSecurity的主要作用是用来构建一条过滤器链，并反映到代码上，也就是构建一个 DefaultSecurityFilterChain 对象，一个 DefaultSecurityFilterChain 对象包含一个路径匹配器和多个Spring Security 过滤器，httpsSecurity 中通过收集各种各样的 xxxConfigurer,将 Spring Security 过滤器对应的配置类收集起来，并保存到父类AbstractConfiguredSecurityBuilder的configurers 变量中，在后续的构建过程中，再将这些xxxConfigurer构建为具体的Spring Security过滤器, 同时添加到httpsSecurity的filters对象中。</p><p>  由于httpsSecurity中存在大量功能类似的方法，因此这里挑选一个作为例子用来说明httpsSecurity的配置原理，代码如下：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">httpsSecurity</span> <span class="keyword">extends</span></span><br><span class="line">		<span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;DefaultSecurityFilterChain, httpsSecurity&gt;</span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">SecurityBuilder</span>&lt;DefaultSecurityFilterChain&gt;,</span><br><span class="line">		httpsSecurityBuilder&lt;httpsSecurity&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RequestMatcherConfigurer requestMatcherConfigurer;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="type">RequestMatcher</span> <span class="variable">requestMatcher</span> <span class="operator">=</span> AnyRequestMatcher.INSTANCE;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">FilterComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterComparator</span>();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">httpsSecurity</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span></span><br><span class="line"><span class="params">			AuthenticationManagerBuilder authenticationBuilder,</span></span><br><span class="line"><span class="params">			Map&lt;Class&lt;? extends Object&gt;, Object&gt; sharedObjects)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(objectPostProcessor);</span><br><span class="line">		Assert.notNull(authenticationBuilder, <span class="string">&quot;authenticationBuilder cannot be null&quot;</span>);</span><br><span class="line">		setSharedObject(AuthenticationManagerBuilder.class, authenticationBuilder);</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt;, Object&gt; entry : sharedObjects</span><br><span class="line">				.entrySet()) &#123;</span><br><span class="line">			setSharedObject((Class&lt;Object&gt;) entry.getKey(), entry.getValue());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (ApplicationContext) sharedObjects</span><br><span class="line">				.get(ApplicationContext.class);</span><br><span class="line">		<span class="built_in">this</span>.requestMatcherConfigurer = <span class="keyword">new</span> <span class="title class_">RequestMatcherConfigurer</span>(context);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> ApplicationContext <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getSharedObject(ApplicationContext.class);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> OpenIDLoginConfigurer&lt;httpsSecurity&gt; <span class="title function_">openidLogin</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">OpenIDLoginConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> HeadersConfigurer&lt;httpsSecurity&gt; <span class="title function_">headers</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">HeadersConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> CorsConfigurer&lt;httpsSecurity&gt; <span class="title function_">cors</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">CorsConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> SessionManagementConfigurer&lt;httpsSecurity&gt; <span class="title function_">sessionManagement</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">SessionManagementConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> PortMapperConfigurer&lt;httpsSecurity&gt; <span class="title function_">portMapper</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">PortMapperConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> JeeConfigurer&lt;httpsSecurity&gt; <span class="title function_">jee</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">JeeConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> X509Configurer&lt;httpsSecurity&gt; <span class="title function_">x509</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">X509Configurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> RememberMeConfigurer&lt;httpsSecurity&gt; <span class="title function_">rememberMe</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">RememberMeConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> ExpressionUrlAuthorizationConfigurer&lt;httpsSecurity&gt;.ExpressionInterceptUrlRegistry <span class="title function_">authorizeRequests</span><span class="params">()</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> getContext();</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">ExpressionUrlAuthorizationConfigurer</span>&lt;&gt;(context))</span><br><span class="line">				.getRegistry();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> RequestCacheConfigurer&lt;httpsSecurity&gt; <span class="title function_">requestCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">RequestCacheConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> ExceptionHandlingConfigurer&lt;httpsSecurity&gt; <span class="title function_">exceptionHandling</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">ExceptionHandlingConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> SecurityContextConfigurer&lt;httpsSecurity&gt; <span class="title function_">securityContext</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">SecurityContextConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> ServletApiConfigurer&lt;httpsSecurity&gt; <span class="title function_">servletApi</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">ServletApiConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> CsrfConfigurer&lt;httpsSecurity&gt; <span class="title function_">csrf</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> getContext();</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">CsrfConfigurer</span>&lt;&gt;(context));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> LogoutConfigurer&lt;httpsSecurity&gt; <span class="title function_">logout</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">LogoutConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> AnonymousConfigurer&lt;httpsSecurity&gt; <span class="title function_">anonymous</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">AnonymousConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> FormLoginConfigurer&lt;httpsSecurity&gt; <span class="title function_">formLogin</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">FormLoginConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> OAuth2LoginConfigurer&lt;httpsSecurity&gt; <span class="title function_">oauth2Login</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">OAuth2LoginConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> ChannelSecurityConfigurer&lt;httpsSecurity&gt;.ChannelRequestMatcherRegistry <span class="title function_">requiresChannel</span><span class="params">()</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> getContext();</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">ChannelSecurityConfigurer</span>&lt;&gt;(context))</span><br><span class="line">				.getRegistry();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsBasicConfigurer&lt;httpsSecurity&gt; <span class="title function_">httpsBasic</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> getOrApply(<span class="keyword">new</span> <span class="title class_">httpsBasicConfigurer</span>&lt;&gt;());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> &lt;C&gt; <span class="keyword">void</span> <span class="title function_">setSharedObject</span><span class="params">(Class&lt;C&gt; sharedType, C object)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>.setSharedObject(sharedType, object);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeConfigure</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		setSharedObject(AuthenticationManager.class, getAuthenticationRegistry().build());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> DefaultSecurityFilterChain <span class="title function_">performBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		Collections.sort(filters, comparator);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSecurityFilterChain</span>(requestMatcher, filters);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">authenticationProvider</span><span class="params">(</span></span><br><span class="line"><span class="params">			AuthenticationProvider authenticationProvider)</span> &#123;</span><br><span class="line">		getAuthenticationRegistry().authenticationProvider(authenticationProvider);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">userDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		getAuthenticationRegistry().userDetailsService(userDetailsService);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> AuthenticationManagerBuilder <span class="title function_">getAuthenticationRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getSharedObject(AuthenticationManagerBuilder.class);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">addFilterAfter</span><span class="params">(Filter filter, Class&lt;? extends Filter&gt; afterFilter)</span> &#123;</span><br><span class="line">		comparator.registerAfter(filter.getClass(), afterFilter);</span><br><span class="line">		<span class="keyword">return</span> addFilter(filter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">addFilterBefore</span><span class="params">(Filter filter,</span></span><br><span class="line"><span class="params">			Class&lt;? extends Filter&gt; beforeFilter)</span> &#123;</span><br><span class="line">		comparator.registerBefore(filter.getClass(), beforeFilter);</span><br><span class="line">		<span class="keyword">return</span> addFilter(filter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">addFilter</span><span class="params">(Filter filter)</span> &#123;</span><br><span class="line">		Class&lt;? <span class="keyword">extends</span> <span class="title class_">Filter</span>&gt; filterClass = filter.getClass();</span><br><span class="line">		<span class="keyword">if</span> (!comparator.isRegistered(filterClass)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">					<span class="string">&quot;The Filter class &quot;</span></span><br><span class="line">							+ filterClass.getName()</span><br><span class="line">							+ <span class="string">&quot; does not have a registered order and cannot be added without a specified order. Consider using addFilterBefore or addFilterAfter instead.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.filters.add(filter);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">addFilterAt</span><span class="params">(Filter filter, Class&lt;? extends Filter&gt; atFilter)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.comparator.registerAt(filter.getClass(), atFilter);</span><br><span class="line">		<span class="keyword">return</span> addFilter(filter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> RequestMatcherConfigurer <span class="title function_">requestMatchers</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestMatcherConfigurer;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">requestMatcher</span><span class="params">(RequestMatcher requestMatcher)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.requestMatcher = requestMatcher;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">antMatcher</span><span class="params">(String antPattern)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(antPattern));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">mvcMatcher</span><span class="params">(String mvcPattern)</span> &#123;</span><br><span class="line">		<span class="type">HandlerMappingIntrospector</span> <span class="variable">introspector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMappingIntrospector</span>(getContext());</span><br><span class="line">		<span class="keyword">return</span> requestMatcher(<span class="keyword">new</span> <span class="title class_">MvcRequestMatcher</span>(introspector, mvcPattern));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> httpsSecurity <span class="title function_">regexMatcher</span><span class="params">(String pattern)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestMatcher(<span class="keyword">new</span> <span class="title class_">RegexRequestMatcher</span>(pattern, <span class="literal">null</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MvcMatchersRequestMatcherConfigurer</span> <span class="keyword">extends</span> <span class="title class_">RequestMatcherConfigurer</span> &#123;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">private</span> <span class="title function_">MvcMatchersRequestMatcherConfigurer</span><span class="params">(ApplicationContext context,</span></span><br><span class="line"><span class="params">				List&lt;MvcRequestMatcher&gt; matchers)</span> &#123;</span><br><span class="line">			<span class="built_in">super</span>(context);</span><br><span class="line">			<span class="built_in">this</span>.matchers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(matchers);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">public</span> RequestMatcherConfigurer <span class="title function_">servletPath</span><span class="params">(String servletPath)</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (RequestMatcher matcher : <span class="built_in">this</span>.matchers) &#123;</span><br><span class="line">				((MvcRequestMatcher) matcher).setServletPath(servletPath);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestMatcherConfigurer</span></span><br><span class="line">			<span class="keyword">extends</span> <span class="title class_">AbstractRequestMatcherRegistry</span>&lt;RequestMatcherConfigurer&gt; &#123;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">protected</span> List&lt;RequestMatcher&gt; matchers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">private</span> <span class="title function_">RequestMatcherConfigurer</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">			setApplicationContext(context);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> MvcMatchersRequestMatcherConfigurer <span class="title function_">mvcMatchers</span><span class="params">(httpsMethod method,</span></span><br><span class="line"><span class="params">				String... mvcPatterns)</span> &#123;</span><br><span class="line">			List&lt;MvcRequestMatcher&gt; mvcMatchers = createMvcMatchers(method, mvcPatterns);</span><br><span class="line">			setMatchers(mvcMatchers);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MvcMatchersRequestMatcherConfigurer</span>(getContext(), mvcMatchers);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> MvcMatchersRequestMatcherConfigurer <span class="title function_">mvcMatchers</span><span class="params">(String... patterns)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> mvcMatchers(<span class="literal">null</span>, patterns);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">protected</span> RequestMatcherConfigurer <span class="title function_">chainRequestMatchers</span><span class="params">(</span></span><br><span class="line"><span class="params">				List&lt;RequestMatcher&gt; requestMatchers)</span> &#123;</span><br><span class="line">			setMatchers(requestMatchers);</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setMatchers</span><span class="params">(List&lt;? extends RequestMatcher&gt; requestMatchers)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.matchers.addAll(requestMatchers);</span><br><span class="line">			requestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(<span class="built_in">this</span>.matchers));</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">public</span> httpsSecurity <span class="title function_">and</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> httpsSecurity.<span class="built_in">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> &lt;C <span class="keyword">extends</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, httpsSecurity&gt;&gt; C <span class="title function_">getOrApply</span><span class="params">(</span></span><br><span class="line"><span class="params">			C configurer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">C</span> <span class="variable">existingConfig</span> <span class="operator">=</span> (C) getConfigurer(configurer.getClass());</span><br><span class="line">		<span class="keyword">if</span> (existingConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> existingConfig;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> apply(configurer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>以form表单登录配置为例，在httpsSecurity中有两个重载方法可以进行配置：第一个是一个无参的formLogin方法，该方法的返回值是一个FormLoginConfigurer<httpssecurity>对象，开发者可以在该对象的基础上继续完善对form表单的配置，我们在前面章节中配置的表单登录都是通过这种方式来进行配置的。第二个是一个有参的formLogin方法，该方法的参数是一个FormLoginConfigurer对象，返回值则是一个httpsSecurity对象，也就是说开发者可以提前在外面配置好FormLoginConfigurer对象，然后直接传进来进行配置即可，返回值 httpsSecurity对象则可以在方法返回后直接进行其他过滤器的配置。无论是有参还是无参，最终都会调用到getOrApply方法，该方法会调用父类的getConfigurer方法去查看是否己经有对应的配置类了，如果有，则直接返回；如果没有，则调用apply方法添加到父类的configurer变量中 httpsSecurity 中其他过滤器的配置都和form表单登录配置类似，这里就不再赘述了。</httpssecurity></li><li>每一套过滤器链都会有一个AuthenticationManager对象来进行认证操作(如果认证失败，则会调用AuthenticationManager的parent再次进行认证)，主要是通过authenticationProvider方法配置执行认证的authenticationProvider对象，通过userDetailsService方法配置 UserDetailsService,最后在 beforeConfigure 方法中触发 AuthenticationManager 对象的构建。</li><li>performBuild方法则是进行DefaultSecurityFilterChain对象的构建，传入请求匹配器和过滤器集合filters,在构建之前，会先按照既定的顺序对filters进行排序。</li><li>通过addFilterAfter、addFilterBefore两个方法，我们可以在某一个过滤器之后或者之前添加一个自定义的过滤器(该方法巳在httpsSecurityBuilder中声明，此处是具体实现)。</li><li>addFilter方法可以向过滤器链中添加一个过滤器，这个过滤器必须是Spring Security 框架提供的过滤器的一个实例或者其扩展，实际上，在每一个xxxConfigurer的configure方法中，都会调用addFilter方法将构建好的过滤器添加到httpsSecurity中的filters集合中(addFilter 方法已在httpsSecurityBuilder中声明，此处是具体实现)。</li><li>addFilterAt方法可以在指定位置添加一个过滤器。需要注意的是，在同一个位置添加多个过滤器并不会覆盖现有的过滤器。</li></ul><p>  这便是httpsSecurity的基本功能。</p><p>WebSecurity：</p><p>  相比于httpsSecurity, WebSecurity是在一个更大的层面上去构建过滤器。一个httpsSecurity 对象可以构建一个过滤器链，也就是一个DefaultSecurityFilterChain对象，而一个项目中可以存在多个httpsSecurity对象，也就可以构建多个DefaultSecurityFilterChain过滤器链。</p><p>WebSecurity 负责将 httpsSecurity 所构建的 DefaultSecurityFilterChain 对象(可能有多个)， 以及其他一些需要忽略的请求，再次重新构建为一个FilterChainProxy对象，同时添加上https 防火墙，</p><p>  我们来看一下WebSecurity中的几个关键方法：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WebSecurity</span> <span class="keyword">extends</span></span><br><span class="line">		<span class="title class_">AbstractConfiguredSecurityBuilder</span>&lt;Filter, WebSecurity&gt; <span class="keyword">implements</span></span><br><span class="line">		<span class="title class_">SecurityBuilder</span>&lt;Filter&gt;, ApplicationContextAware &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;RequestMatcher&gt; ignoredRequests = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;SecurityBuilder&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityFilterChain</span>&gt;&gt; securityFilterChainBuilders = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SecurityBuilder&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityFilterChain</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> IgnoredRequestConfigurer ignoredRequestRegistry;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> FilterSecurityInterceptor filterSecurityInterceptor;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> httpsFirewall httpsFirewall;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> debugEnabled;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> WebInvocationPrivilegeEvaluator privilegeEvaluator;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">DefaultWebSecurityExpressionHandler</span> <span class="variable">defaultWebSecurityExpressionHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityExpressionHandler</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SecurityExpressionHandler&lt;FilterInvocation&gt; expressionHandler = defaultWebSecurityExpressionHandler;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">Runnable</span> <span class="variable">postBuildAction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">WebSecurity</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(objectPostProcessor);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> IgnoredRequestConfigurer <span class="title function_">ignoring</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ignoredRequestRegistry;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebSecurity <span class="title function_">httpsFirewall</span><span class="params">(httpsFirewall httpsFirewall)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.httpsFirewall = httpsFirewall;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebSecurity <span class="title function_">debug</span><span class="params">(<span class="type">boolean</span> debugEnabled)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.debugEnabled = debugEnabled;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebSecurity <span class="title function_">addSecurityFilterChainBuilder</span><span class="params">(</span></span><br><span class="line"><span class="params">			SecurityBuilder&lt;? extends SecurityFilterChain&gt; securityFilterChainBuilder)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.securityFilterChainBuilders.add(securityFilterChainBuilder);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebSecurity <span class="title function_">privilegeEvaluator</span><span class="params">(</span></span><br><span class="line"><span class="params">			WebInvocationPrivilegeEvaluator privilegeEvaluator)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.privilegeEvaluator = privilegeEvaluator;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebSecurity <span class="title function_">expressionHandler</span><span class="params">(</span></span><br><span class="line"><span class="params">			SecurityExpressionHandler&lt;FilterInvocation&gt; expressionHandler)</span> &#123;</span><br><span class="line">		Assert.notNull(expressionHandler, <span class="string">&quot;expressionHandler cannot be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.expressionHandler = expressionHandler;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> SecurityExpressionHandler&lt;FilterInvocation&gt; <span class="title function_">getExpressionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> expressionHandler;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebInvocationPrivilegeEvaluator <span class="title function_">getPrivilegeEvaluator</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (privilegeEvaluator != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> privilegeEvaluator;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> filterSecurityInterceptor == <span class="literal">null</span> ? <span class="literal">null</span></span><br><span class="line">				: <span class="keyword">new</span> <span class="title class_">DefaultWebInvocationPrivilegeEvaluator</span>(filterSecurityInterceptor);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebSecurity <span class="title function_">securityInterceptor</span><span class="params">(FilterSecurityInterceptor securityInterceptor)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.filterSecurityInterceptor = securityInterceptor;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> WebSecurity <span class="title function_">postBuildAction</span><span class="params">(Runnable postBuildAction)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.postBuildAction = postBuildAction;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Filter <span class="title function_">performBuild</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		Assert.state(</span><br><span class="line">				!securityFilterChainBuilders.isEmpty(),</span><br><span class="line">				<span class="string">&quot;At least one SecurityBuilder&lt;? extends SecurityFilterChain&gt; needs to be specified. Typically this done by adding a @Configuration that extends WebSecurityConfigurerAdapter. More advanced users can invoke &quot;</span></span><br><span class="line">						+ WebSecurity.class.getSimpleName()</span><br><span class="line">						+ <span class="string">&quot;.addSecurityFilterChainBuilder directly&quot;</span>);</span><br><span class="line">		<span class="type">int</span> <span class="variable">chainSize</span> <span class="operator">=</span> ignoredRequests.size() + securityFilterChainBuilders.size();</span><br><span class="line">		List&lt;SecurityFilterChain&gt; securityFilterChains = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">				chainSize);</span><br><span class="line">		<span class="keyword">for</span> (RequestMatcher ignoredRequest : ignoredRequests) &#123;</span><br><span class="line">			securityFilterChains.add(<span class="keyword">new</span> <span class="title class_">DefaultSecurityFilterChain</span>(ignoredRequest));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (SecurityBuilder&lt;? <span class="keyword">extends</span> <span class="title class_">SecurityFilterChain</span>&gt; securityFilterChainBuilder : securityFilterChainBuilders) &#123;</span><br><span class="line">			securityFilterChains.add(securityFilterChainBuilder.build());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">FilterChainProxy</span> <span class="variable">filterChainProxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterChainProxy</span>(securityFilterChains);</span><br><span class="line">		<span class="keyword">if</span> (httpsFirewall != <span class="literal">null</span>) &#123;</span><br><span class="line">			filterChainProxy.setFirewall(httpsFirewall);</span><br><span class="line">		&#125;</span><br><span class="line">		filterChainProxy.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">		<span class="type">Filter</span> <span class="variable">result</span> <span class="operator">=</span> filterChainProxy;</span><br><span class="line">		<span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">			logger.warn(<span class="string">&quot;\n\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;********************************************************************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;**********    This may include sensitive information.  *************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;**********      Do not use in a production system!     *************\n&quot;</span></span><br><span class="line">					+ <span class="string">&quot;********************************************************************\n\n&quot;</span>);</span><br><span class="line">			result = <span class="keyword">new</span> <span class="title class_">DebugFilter</span>(filterChainProxy);</span><br><span class="line">		&#125;</span><br><span class="line">		postBuildAction.run();</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MvcMatchersIgnoredRequestConfigurer</span></span><br><span class="line">			<span class="keyword">extends</span> <span class="title class_">IgnoredRequestConfigurer</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> List&lt;MvcRequestMatcher&gt; mvcMatchers;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="title function_">MvcMatchersIgnoredRequestConfigurer</span><span class="params">(ApplicationContext context,</span></span><br><span class="line"><span class="params">				List&lt;MvcRequestMatcher&gt; mvcMatchers)</span> &#123;</span><br><span class="line">			<span class="built_in">super</span>(context);</span><br><span class="line">			<span class="built_in">this</span>.mvcMatchers = mvcMatchers;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> IgnoredRequestConfigurer <span class="title function_">servletPath</span><span class="params">(String servletPath)</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (MvcRequestMatcher matcher : <span class="built_in">this</span>.mvcMatchers) &#123;</span><br><span class="line">				matcher.setServletPath(servletPath);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IgnoredRequestConfigurer</span></span><br><span class="line">			<span class="keyword">extends</span> <span class="title class_">AbstractRequestMatcherRegistry</span>&lt;IgnoredRequestConfigurer&gt; &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="title function_">IgnoredRequestConfigurer</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">			setApplicationContext(context);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> MvcMatchersIgnoredRequestConfigurer <span class="title function_">mvcMatchers</span><span class="params">(httpsMethod method,</span></span><br><span class="line"><span class="params">				String... mvcPatterns)</span> &#123;</span><br><span class="line">			List&lt;MvcRequestMatcher&gt; mvcMatchers = createMvcMatchers(method, mvcPatterns);</span><br><span class="line">			WebSecurity.<span class="built_in">this</span>.ignoredRequests.addAll(mvcMatchers);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MvcMatchersIgnoredRequestConfigurer</span>(getApplicationContext(),</span><br><span class="line">					mvcMatchers);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> MvcMatchersIgnoredRequestConfigurer <span class="title function_">mvcMatchers</span><span class="params">(String... mvcPatterns)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> mvcMatchers(<span class="literal">null</span>, mvcPatterns);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">protected</span> IgnoredRequestConfigurer <span class="title function_">chainRequestMatchers</span><span class="params">(</span></span><br><span class="line"><span class="params">				List&lt;RequestMatcher&gt; requestMatchers)</span> &#123;</span><br><span class="line">			WebSecurity.<span class="built_in">this</span>.ignoredRequests.addAll(requestMatchers);</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> WebSecurity <span class="title function_">and</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> WebSecurity.<span class="built_in">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span></span><br><span class="line">			<span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="built_in">this</span>.defaultWebSecurityExpressionHandler</span><br><span class="line">				.setApplicationContext(applicationContext);</span><br><span class="line">		<span class="built_in">this</span>.ignoredRequestRegistry = <span class="keyword">new</span> <span class="title class_">IgnoredRequestConfigurer</span>(applicationContext);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>首先在WebSecurity中声明了 ignoredRequests集合，这个集合中保存了所有被忽略的请求，因为在实际项目中，并非所有的请求都需要经过Spring Security过滤器链，有一些静态资源可能不需要权限认证，直接返回给客户端即可，那么这些需要忽略的请求可以直接保存 在 ignoredRequests 变量中。</li><li>接下来声明了一个securityFilterChainBuilders集合，该集合用来保存所有的 httpsSecurity 对象，每一个 httpsSecurity 对象创建成功之后，通过 addSecurityFliterChainBuilder 方法将 httpsSecurity 对象添加到 securityFilterChainBuilders 集合中。</li><li>httpsFirewall方法可以用来配置请求防火墙，关于请求防火墙，我们会在后面的章节中专门讲解。</li><li>performBuild方法则是具体的构建方法，在该方法中，首先统计出过滤器链的总个数(被忽略的请求个数+通过httpsSecurity创建出来的过滤器链个数)，然后创建一个集合 securityFilterChains,遍历被忽略的请求并分别构建成DefaultSecurityFilterChain对象保存到 securityFilterChains集合中。需要注意的是，对于被忽略的请求，在构建DefaultSecurityFilterChain对象时，只是传入了请求匹配器，而没有传入对应的过滤器链，这就意味着这些被忽略掉的请求，将来不必经过Spring Security过滤器链；接下来再遍历securityFilterChainBuilders集合，调用每个对象的build方法构建DefaultSecurityFilterChain并存入securityFilterChains集合中，然后传入securityFilterChains集合构建FilterChainProxy对象，最后再设置https 防火墙。所有设置完成之后，最后返回filterChainProxy对象。</li></ul><p>  FilterChainProxy就是我们最终构建出来的代理过滤器链，通过Spring提供的DelegatingFilterProxy将FilterChainProxy对象嵌入到WebFilter中(原生过滤器链中)。</p><p>  读者可以回忆一下前面我们绘制的FilterChainProxy架构图，对照着来理解上面的源码应该就很容易了，如图4-3所示。</p><p>  至此，关于SecurityBuilder体系中的几个关键类就介绍完了 ,至于httpsSecurity和 WebSecurity是怎么配置到一起的，我们将在后面的章节中进行分析。</p><p>  <img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%883%EF%BC%89.png"></p><center>图 4-3</center><h2 id="1-4-FilterChainProxy"><a href="#1-4-FilterChainProxy" class="headerlink" title="1.4 FilterChainProxy"></a>1.4 FilterChainProxy</h2><p>FilterChainProxy 通过 DelegatingFilterProxy 代理过滤器被集成到 WebFilter 中, DelegatingFilterProxy作为一个代理对象，相信很多读者可能都用过(例如在Spring中整合Shiro 就会用到)，它不承载具体的业务。所以，Spring Security中的过滤器链的最终执行，就是在FilterChainProxy中，因此这里也 来分析一下FilterChainProxy的源码。</p><p>  FilterChainProxy的源码比较长，我们一段一段来看：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;SecurityFilterChain&gt; filterChains;</span><br><span class="line"><span class="keyword">private</span> <span class="type">FilterChainValidator</span> <span class="variable">filterChainValidator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NullFilterChainValidator</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="type">httpsFirewall</span> <span class="variable">firewall</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StricthttpsFirewall</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FilterChainProxy</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FilterChainProxy</span><span class="params">(SecurityFilterChain chain)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(Arrays.asList(chain));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FilterChainProxy</span><span class="params">(List&lt;SecurityFilterChain&gt; filterChains)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.filterChains = filterChains;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先声明了三个变量：</p><ul><li>由于在Spring Security中可以同时存在多个过滤器链,filterchains就是用来保存过滤器链的，注意保存的是过滤器链，而不是一个个具体的过滤器，</li><li>FilterChainValidator是一个过滤器链配置完成后的验证器，默认使用 NullFilterChainValidator其实没有做任何验证。</li><li>创建了一个默认的防火墙对象firewall。</li></ul><p>在构造方法中传入过滤器链的集合，并赋值给filterChains变量。</p><p>由于FilterChainProxy本质上就是一个过滤器，因此它的核心方法就是doFilter方法，接下来我们来看一下doFilter方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">                     FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">clearContext</span> <span class="operator">=</span> request.getAttribute(FILTER_APPLIED) == <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (clearContext) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            request.setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">            doFilterInternal(request, response, chain);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            SecurityContextHolder.clearContext();</span><br><span class="line">            request.removeAttribute(FILTER_APPLIED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        doFilterInternal(request, response, chain);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  doFilter方法相当于是整个Spring Security过滤器链的入口，我们在前面章节中所涉及的 一些具体的过滤器如SecurityContextPersistenceFilter,都是在该doFilter方法之后执行的。作 为整个过滤器链的入口，这里多了一个clearContext变量，如果是第一次执行该doFilter方法, 执行完成后，在finally代码块中需要从SecurityContextHolder里清除用户信息，这个主要是为了防止用户没有正确配置SecurityContextPersistenceFilter,从而导致登录用户信息没有被正确清除，进而发生内存泄漏。</p><p>  在doFilter方法中，过滤器的具体执行则交给了 doFilterlnternal方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">                              FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException</span><br><span class="line">                              </span><br><span class="line">    <span class="type">FirewalledRequest</span> <span class="variable">fwRequest</span> <span class="operator">=</span> firewall.getFirewalledRequest((httpsServletRequest) request);</span><br><span class="line">    <span class="type">httpsServletResponse</span> <span class="variable">fwResponse</span> <span class="operator">=</span> firewall.getFirewalledResponse((httpsServletResponse) response);</span><br><span class="line"></span><br><span class="line">    List&lt;Filter&gt; filters = getFilters(fwRequest);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filters == <span class="literal">null</span> || filters.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(UrlUtils.buildRequestUrl(fwRequest)</span><br><span class="line">                         + (filters == <span class="literal">null</span> ? <span class="string">&quot; has no matching filters&quot;</span></span><br><span class="line">                            : <span class="string">&quot; has an empty filter list&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        fwRequest.reset();</span><br><span class="line">        chain.doFilter(fwRequest, fwResponse);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">VirtualFilterChain</span> <span class="variable">vfc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VirtualFilterChain</span>(fwRequest, chain, filters);</span><br><span class="line">    vfc.doFilter(fwRequest, fwResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  在doFilterlnternal方法中，首先会将request对象转换为一个FirewalledRequest对象，这个转换过程会进行https防火墙处理(https防火墙将在后面详细介绍),同时将response对象也转为httpsServletResponse。接下来调用getFilters方法获取当前请求对应的过滤器链， getFilters方法会遍历filterchains集合，进而判断出当前请求和哪一个过滤器链是对应的，如果找到的过滤器链filters为null,或者filters中没有元素，说明当前请求并不需要经过SpringSecurity过滤器链，此时执行Request.reset方法对https防火墙中的属性进行重置，再执行 chain.doFilter方法，回到WebFilter中，Spring Security过滤器链将被跳过(回忆上一小结 WebSecurity中配置的忽略请求)。如果filters集合中是有元素的，也就是说当前请求需要经过filters集合中元素所构成的过滤器链,那么构建一个虚拟的过滤器链对象VirtualFilterChain， 并执行其doFilter方法。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">VirtualFilterChain</span> <span class="keyword">implements</span> <span class="title class_">FilterChain</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FilterChain originalChain;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Filter&gt; additionalFilters;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FirewalledRequest firewalledRequest;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">currentPosition</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">VirtualFilterChain</span><span class="params">(FirewalledRequest firewalledRequest,</span></span><br><span class="line"><span class="params">                               FilterChain chain, List&lt;Filter&gt; additionalFilters)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.originalChain = chain;</span><br><span class="line">        <span class="built_in">this</span>.additionalFilters = additionalFilters;</span><br><span class="line">        <span class="built_in">this</span>.size = additionalFilters.size();</span><br><span class="line">        <span class="built_in">this</span>.firewalledRequest = firewalledRequest;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentPosition == size) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(UrlUtils.buildRequestUrl(firewalledRequest)</span><br><span class="line">                             + <span class="string">&quot; reached end of additional filter chain; proceeding with original chain&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.firewalledRequest.reset();</span><br><span class="line">            originalChain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            currentPosition++;</span><br><span class="line">            <span class="type">Filter</span> <span class="variable">nextFilter</span> <span class="operator">=</span> additionalFilters.get(currentPosition - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(UrlUtils.buildRequestUrl(firewalledRequest)</span><br><span class="line">                             + <span class="string">&quot; at position &quot;</span> + currentPosition + <span class="string">&quot; of &quot;</span> + size</span><br><span class="line">                             + <span class="string">&quot; in additional filter chain; firing Filter: &#x27;&quot;</span></span><br><span class="line">                             + nextFilter.getClass().getSimpleName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            nextFilter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VirtualFilterChain中首先声明了五个变量:</p><ul><li>originalChain：表示原生的过滤器链，执行它的doFilter方法会回到WebFilter中。</li><li>additionalFilters：这个List集合中存储的Filter就是本次请求的Filter。</li><li>firewalledRequest:当前请求对象。</li><li>size：过滤器链的大小。</li><li>currentPosition：过滤器链执行的下标。</li></ul><p>  在VirtualFilterChain的构造方法中，会给相应的变量赋值。</p><p>  在doFilter方法中，会首先判断当前执行的下标是否等于过滤器链的大小，如果相等，则说明整个过滤器链中的所有过滤器都已经挨个走一遍了，此时先对https防火墙中的属性进行重置，然后调用。originalChain.doFilter 方法跳出Spring Security Filter,回到 WebFilter；如果不相等，则currentPosition自增，然后从过滤器链集合中取出一个过滤器去执行，注意执行的时候第三个参数this表示当前对象(即VirtualFilterChain),这样在每一个过滤器执行完之后， 最后的chain.doFilter方法又会回到当前doFilter方法中，继续下一个过滤器的调用.</p><p>  这就是FilterChainProxy的一个大致工作原理。</p><h2 id="1-5-SecurityConfigurer"><a href="#1-5-SecurityConfigurer" class="headerlink" title="1.5 SecurityConfigurer"></a>1.5 SecurityConfigurer</h2><p>SecurityConfigurer中有两个核心方法，一个是init方法，用来完成配置类的初始化操作， 另外一个是configure方法，进行配置类的配置。上一小结介绍的 AbstractConfiguredSecurityBuilder类，里边的init方法和configure其实就是在遍历执行不同配 置类的init和configure方法。</p><p>  SecurityConfigurer的实现类比较多，这里主要梳理一下常见的SecurityConfigurer实现类, 我们分别来看一下。</p><p>  SecurityConfigurer：</p><p>  先来看源码,代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B <span class="keyword">extends</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt;&gt; &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">init</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，SecurityConfigurer只有两个方法：init和configure,两个方法的参数都是 SecurityBuilder对象，也就是说在这两个方法中对SecurityBuilder进行初始化和配置。</p><p>  SecurityConfigurer的类非常多，因为每一个过滤器都有自己对应的xxxConfigiuer,这 里着重介绍几个关键的实现类，如图4-4所示。</p><p>  <img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%884%EF%BC%89.png"></p><center>图 4-4</center><p>  我们分别来看这几个实现类：</p><p>  SecurityConfigurerAdapter</p><p>  SecurityConfigurerAdapter 实现了 SecurityConfigurer 接口，它的源码如下：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;O, B <span class="keyword">extends</span> <span class="title class_">SecurityBuilder</span>&lt;O&gt;&gt;</span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">SecurityConfigurer</span>&lt;O, B&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> B securityBuilder;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">CompositeObjectPostProcessor</span> <span class="variable">objectPostProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompositeObjectPostProcessor</span>();</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(B builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> B <span class="title function_">and</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getBuilder();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> B <span class="title function_">getBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (securityBuilder == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;securityBuilder cannot be null&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> securityBuilder;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">postProcess</span><span class="params">(T object)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (T) <span class="built_in">this</span>.objectPostProcessor.postProcess(object);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addObjectPostProcessor</span><span class="params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.objectPostProcessor.addObjectPostProcessor(objectPostProcessor);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBuilder</span><span class="params">(B builder)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.securityBuilder = builder;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CompositeObjectPostProcessor</span> <span class="keyword">implements</span></span><br><span class="line">			<span class="title class_">ObjectPostProcessor</span>&lt;Object&gt; &#123;</span><br><span class="line">		<span class="keyword">private</span> List&lt;ObjectPostProcessor&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt;&gt; postProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ObjectPostProcessor&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">		<span class="keyword">public</span> Object <span class="title function_">postProcess</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (ObjectPostProcessor opp : postProcessors) &#123;</span><br><span class="line">				Class&lt;?&gt; oppClass = opp.getClass();</span><br><span class="line">				Class&lt;?&gt; oppType = GenericTypeResolver.resolveTypeArgument(oppClass,</span><br><span class="line">						ObjectPostProcessor.class);</span><br><span class="line">				<span class="keyword">if</span> (oppType == <span class="literal">null</span> || oppType.isAssignableFrom(object.getClass())) &#123;</span><br><span class="line">					object = opp.postProcess(object);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> object;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addObjectPostProcessor</span><span class="params">(</span></span><br><span class="line"><span class="params">				ObjectPostProcessor&lt;? extends Object&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">			<span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.postProcessors.add(objectPostProcessor);</span><br><span class="line">			Collections.sort(postProcessors, AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  从这段源码中，我们可以分析出SecurityConfigurerAdapter主要做了如下几件事：</p><ul><li>提供了一个SecurityBuilder对象，为每一个配置类都提供一个SecurityBuilder对象, 将来通过SecurityBuilder构建出具体的配置对象；通过and方法返回SecurityBuilder对象，这样方便不同的配置类在配置时，可以进行链式配置(第2章中我们在定义SecurityConfig时所使用的and方法)。</li><li>定义了内部类CompositeObjectPostProcessor这是一个复合的对象后置处理器。</li><li>提供了一个addObjectPostProcessor方法，通过该方法可以向复合的对象后置处理器中添加新的ObjectPostProcessor实例。</li></ul><p>  这是SecurityConfigurerAdapter提供的主要功能。</p><p>  UserDetailsAwareConfigurer：</p><p>  UserDetailsAwareConfigurer的子类主要负责配置用户认证相关的组件，如UserDetailsService 等，UserDetailsAwareConfigurer 中提供了获取 UserDetailsService 的抽象方法，具体实现则在它的子类中，UserDetailsAwareConfigurer的子类如图4-5所示。</p><p>  <img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%885%EF%BC%89.png"></p><center>图 4-5</center><ul><li>AbstractDaoAuthenticationConfigurer： 完成时 DaoAuthenticationProvider 的配置。</li><li>UserDetailsServiceConfigurer:完成对 UserDetailsService 的配置。</li><li>UserDetailsManagerConfigurer :使用 UserDetailsManager 构建用户 对象，完成对 AuthenticationManagerBuilder 的填充。</li><li>JdbcUserDetailsManagerConfigurer：配置 JdbcUserDetailsManager 并填充到 AuthenticationManagerBuilder</li><li>InMemoryUserDetailsManagerConfigurer:配置 InMemoryUserDetailsManager。</li><li>DaoAuthenticationConfigurer: 完成对 DaoAuthenticationProvider 的配置。</li></ul><p>  AbstracthttpsConfigurer：</p><p>  AbstracthttpsConfigurer主要是为了给在httpsSecurity中使用的配置类添加一个方便的父类，提取岀共同的操作。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstracthttpsConfigurer</span>&lt;T <span class="keyword">extends</span> <span class="title class_">AbstracthttpsConfigurer</span>&lt;T, B&gt;, B <span class="keyword">extends</span> <span class="title class_">httpsSecurityBuilder</span>&lt;B&gt;&gt;</span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, B&gt; &#123;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> B <span class="title function_">disable</span><span class="params">()</span> &#123;</span><br><span class="line">		getBuilder().removeConfigurer(getClass());</span><br><span class="line">		<span class="keyword">return</span> getBuilder();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> T <span class="title function_">withObjectPostProcessor</span><span class="params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> &#123;</span><br><span class="line">		addObjectPostProcessor(objectPostProcessor);</span><br><span class="line">		<span class="keyword">return</span> (T) <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以看到，提取出来的方法其实就两个：一个disable表示禁用某一个配置(前面章节中我们配置的.csrf().disable。),本质上就是从构建器的configurers集合中移除某一个配置类，这样在将来构建的时候就不存在该配置类，那么对应的功能也就不存在(被禁用)；另一个 withObjectPostProcessor表示给某一个对象添加一个对象后置处理器，由于该方法的返回值是当前对象，所以该方法可以用在链式配置中。</p><p>  AbstracthttpsConfigurer的实现类比较多，基本上都用来配置务种各样的过滤器，参见表 4-1。</p><p>  <img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%886%EF%BC%89.png"></p><p><img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%887%EF%BC%89.png"></p><center>表4-1</center><p>GlobalAuthenticationConfigurerAdapter：</p><p>GlobalAuthenticationConfigurerAdapter 主要用于配置全局 AuthenticationManagerBuilder, 在 AuthenticationConfiguration 类中会自动使用 GlobalAuthenticationConfigurerAdapter 提供的 Bean 来配置全局 AuthenticationManagerBuilder。</p><p>  在第3章介绍ProviderManager时曾经提到过，默认情况下ProviderManager有一个parent, 这个parent就是通过这里的全局AuthenticationManagerBuilder来构建的。</p><p>GlobalAuthenticationConfigurerAdapter 有四个不同的子类，如图 4-6 所示。</p><p>  <img src="https://image.buretuzi.online/blog/article/springSecurity/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89%EF%BC%888%EF%BC%89.png"></p><center>图 4-6</center><ul><li>InitializeAuthenticationProviderBeanManagerConfigurer: 初始化全局的 AuthenticationProvider对象。</li><li>InitializeAuthenticationProviderManagerConfigurer:配置全局的 AuthenticationProvider对象，配置过程就是从Spring容器中查找 AuthenticationProvider并设置给全局的 AuthenticationManagerBuilder 对象。</li><li>InitializeUserDetailsBeanManagerConfigurer：初始化全局的 UserDetailsService 对象。</li><li>InitializeUserDetailsManagerConfigurer:配置全局的 UserDetailsService 对象，配置过程就是从 Spring 容器中查找 UserDetailsService,并设置给全局的 AuthenticationManagerBuilder 对象。</li><li>EnableGlobalAuthenticationAutowiredConfigurer：从 Spring 容器中加载被@EnableGlobalAuthentication注解标记的Bean。</li></ul><p>  WebSecurityConfigurer：</p><p>  WebSecurityConfigurer是一个空接口，我们可以通过它来自定义 WebSecurity。 WebSecurityConfigurer 只有一个实现类就是 WebSecurityConfigurerAdapter,在大多数情况下, 升发者通过继承WebSecurityConfigurerAdapter来实现对WebSecurity的自定义配置。</p><p>  WebSecurityConfigurerAdapter：</p><p>  WebSecurityConfigurerAdapter 是一个可以方便创建 WebSecurityConfigurer 实例的基类， 开发者可以通过覆盖 WebSecurityConfigurerAdapter中的方法完成对httpsSecurity和 WebSecurity的定制，在前面的章节中，我们所定制的Spring Security登录都是通过自定义类继承 WebSecurityConfigurerAdapter来实现的。</p><p>  在 WebSecurityConfiginerAdapter 中声明了 两个 AuthenticationManagerBuilder 对象用来构 建 AuthenticationManager：</p><p>  private AuthenticationManagerBuilder authenticationBuilder;</p><p>  private AuthenticationManagerBuilder localConfigureAuthenticationBuilder;</p><p>  其中，localConfigureAuthenticationBuilder对象负责构建全局的 AuthenticationManager,而 authenticationBuilder 则负责构建局部的 AutlienticationManager。 局部的 AuthenticationManager 是和每一个httpsSecurity对象绑定的，而全局的AuthenticationManager对象则是所有局部AuthenticationManager 的 parent。需要注意的足，localConfigureAuthenticationBuilder并非总是有用,在开发者没有重写configure(AuthenticationManagerBuilder)方法的情况下，全局的 AuthenticationManager 对象是由 Authenticationconfiguration 类中的 getAuthenticationManager 方法提供的，如果用户重写了 configure(AuthenticationManagerBuilder)方法，则全局的 AuthenticationManager 就由 localConfigureAuthenticationBuilder负责构建。这里可能会感觉有点绕，在后面的小节中，我们将通过实际的例子展示全局AuthenticationManager对象的构建。</p><p>  WebSecurityConfigurerAdapter 类的初始化方法如下：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">protected</span> <span class="title function_">WebSecurityConfigurerAdapter</span><span class="params">(<span class="type">boolean</span> disableDefaults)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.logger = LogFactory.getLog(WebSecurityConfigurerAdapter.class);</span><br><span class="line">    <span class="built_in">this</span>.contentNegotiationStrategy = <span class="keyword">new</span> <span class="title class_">HeaderContentNegotiationStrategy</span>();</span><br><span class="line">    <span class="built_in">this</span>.objectPostProcessor = <span class="keyword">new</span> <span class="title class_">ObjectPostProcessor</span>&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">postProcess</span><span class="params">(T object)</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(ObjectPostProcessor.class.getName() + <span class="string">&quot; is a required bean. Ensure you have used @EnableWebSecurity and @Configuration&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">this</span>.trustResolver = <span class="keyword">new</span> <span class="title class_">AuthenticationTrustResolverImpl</span>();</span><br><span class="line">    <span class="built_in">this</span>.disableDefaults = disableDefaults;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="built_in">this</span>.disableLocalConfigureAuthenticationBldr = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> httpsSecurity <span class="title function_">gethttps</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.https != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.https;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">AuthenticationEventPublisher</span> <span class="variable">eventPublisher</span> <span class="operator">=</span> <span class="built_in">this</span>.getAuthenticationEventPublisher();</span><br><span class="line">        <span class="built_in">this</span>.localConfigureAuthenticationBldr.authenticationEventPublisher(eventPublisher);</span><br><span class="line">        <span class="type">AuthenticationManager</span> <span class="variable">authenticationManager</span> <span class="operator">=</span> <span class="built_in">this</span>.authenticationManager();</span><br><span class="line">        <span class="built_in">this</span>.authenticationBuilder.parentAuthenticationManager(authenticationManager);</span><br><span class="line">        Map&lt;Class&lt;?&gt;, Object&gt; sharedObjects = <span class="built_in">this</span>.createSharedObjects();</span><br><span class="line">        <span class="built_in">this</span>.https = <span class="keyword">new</span> <span class="title class_">httpsSecurity</span>(<span class="built_in">this</span>.objectPostProcessor, <span class="built_in">this</span>.authenticationBuilder, sharedObjects);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.disableDefaults) &#123;</span><br><span class="line">            ((httpsSecurity)((DefaultLoginPageConfigurer)((httpsSecurity)((httpsSecurity)((httpsSecurity)((httpsSecurity)((httpsSecurity)((httpsSecurity)((httpsSecurity)((httpsSecurity)<span class="built_in">this</span>.https.csrf().and()).addFilter(<span class="keyword">new</span> <span class="title class_">WebAsyncManagerIntegrationFilter</span>()).exceptionHandling().and()).headers().and()).sessionManagement().and()).securityContext().and()).requestCache().and()).anonymous().and()).servletApi().and()).apply(<span class="keyword">new</span> <span class="title class_">DefaultLoginPageConfigurer</span>())).and()).logout();</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="built_in">this</span>.context.getClassLoader();</span><br><span class="line">            List&lt;AbstracthttpsConfigurer&gt; defaulthttpsConfigurers = SpringFactoriesLoader.loadFactories(AbstracthttpsConfigurer.class, classLoader);</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> defaulthttpsConfigurers.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                <span class="type">AbstracthttpsConfigurer</span> <span class="variable">configurer</span> <span class="operator">=</span> (AbstracthttpsConfigurer)var6.next();</span><br><span class="line">                <span class="built_in">this</span>.https.apply(configurer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.configure(<span class="built_in">this</span>.https);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.https;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebSecurityConfigurerAdapter</span>.AuthenticationManagerDelegator(<span class="built_in">this</span>.authenticationBuilder, <span class="built_in">this</span>.context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.authenticationManagerInitialized) &#123;</span><br><span class="line">        <span class="built_in">this</span>.configure(<span class="built_in">this</span>.localConfigureAuthenticationBldr);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.disableLocalConfigureAuthenticationBldr) &#123;</span><br><span class="line">            <span class="built_in">this</span>.authenticationManager = <span class="built_in">this</span>.authenticationConfiguration.getAuthenticationManager();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.authenticationManager = (AuthenticationManager)<span class="built_in">this</span>.localConfigureAuthenticationBldr.build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.authenticationManagerInitialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.authenticationManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">httpsSecurity</span> <span class="variable">https</span> <span class="operator">=</span> <span class="built_in">this</span>.gethttps();</span><br><span class="line">    web.addSecurityFilterChainBuilder(https).postBuildAction(() -&gt; &#123;</span><br><span class="line">        <span class="type">FilterSecurityInterceptor</span> <span class="variable">securityInterceptor</span> <span class="operator">=</span> (FilterSecurityInterceptor)https.getSharedObject(FilterSecurityInterceptor.class);</span><br><span class="line">        web.securityInterceptor(securityInterceptor);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(httpsSecurity https)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Using default configure(httpsSecurity). If subclassed this will potentially override subclass configure(httpsSecurity).&quot;</span>);</span><br><span class="line">    ((httpsSecurity)((httpsSecurity)((AuthorizedUrl)https.authorizeRequests().anyRequest()).authenticated().and()).formLogin().and()).httpsBasic();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在init方法中，首先调用gethttps方法获取一个httpsSecurity实例，并将获取到的实例添加到WebSecurity对象中，再由WebSecurity对象进行构建。</li><li>在gethttps方法中，如果https对象已经初始化，则直接返回，否则进行初始化操作。 在初始化的过程中，给localConfigureAuthenticationBuilder设置事件发布器，并调用 authenticationManager 方法获取全局的 AuthenticationManager 对象。</li><li>在 authenticationManager 方法中，如果全局的 AuthenticationManager 对象还没有初始化，则先调用configure方法，该方法的逻辑很简单，就是将disableLocalConfigureAuthenticationBIdr变量:由 false 变为 true,接下来就会进入到 authenticationManager 方法的 if 分支中，通 过调用 authenticationConfiguration.getAuthenticationManager()方法获取全局的 AuthenticationManager 对象并返回也如果开发者自己重写了 configure(AuthenticationManager Builder)方法，则 disableLocalConfigureAuthenticationBldr 变量就一直是 false,没有机会变为 true,这样就会进入到else分支中，通过localConfignreAuthenticationBldr变量来构建 authenticationManager 对象。</li><li>再次回到gethttps方法中，获取到全局的authenticationManager对象之后，设置给 autheuticationBuilder,然后创建一个httpsSecurity实例岀来，并为其配置上默认的过滤器。默认的配置完成后，调用configure(httpsSecurity)方法进行扩展配置，WebSecurityConfigurer Adapter中对configure(httpsSecurity)方法提供了默认的实现，开发者也可以自定义该方法。</li></ul><p>  这就是 WebSecurityConfigurerAdapter的初始化方法，其实就是创建并配置一个 httpsSecurity实例，之后添加到WebSecurity中。</p><p>  WebSecurityConfigurerAdapter中的configure方法是一个空方法，可以用来配置 WebSecurity,代码如下：</p><p>  public void configure(WebSecurity web) throws Exception {</p><p>  }</p><p>  一般来说，如果我们有一些静态资源不需要经过Spring Security过滤器，就可以通过重写该方法实现。</p><p>  至此，在Spring Security初始化过程中，几个重要的组件都介绍完了，单纯的源码读者看起来可能会比较枯燥，在后面的小节中，我会结合大量的应用案例，来帮助大家深入理解源码。</p><p>  不过在讲解具体的案例之前，我们还是先来分析一遍Sprmg Security的初始化流程，将前面讲的这些知识点串起来。</p><h2 id="1-6-初始化流程分析"><a href="#1-6-初始化流程分析" class="headerlink" title="1.6 初始化流程分析"></a>1.6 初始化流程分析</h2><p>在Spring Boot中使用Spring Security,初始化就从Spring Security的自动化配置类中开始:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DefaultAuthenticationEventPublisher.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SecurityProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; SpringBootWebSecurityConfiguration.class, WebSecurityEnablerConfiguration.class,</span></span><br><span class="line"><span class="meta">		SecurityDataConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(AuthenticationEventPublisher.class)</span></span><br><span class="line">	<span class="keyword">public</span> DefaultAuthenticationEventPublisher <span class="title function_">authenticationEventPublisher</span><span class="params">(ApplicationEventPublisher publisher)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultAuthenticationEventPublisher</span>(publisher);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以看到，在自动化配置类SecurityAutoConfiguration中,最重要的就是导入了三个配置类，并且定义了一个默认的事件发布器。</p><p>  导入的三个配置类中，SpringBootWebSecurityConfiguration的主要作用是在开发者没有提 供 WebSecurityConfigurerAdapter实例的情况下，由其负责提供一个默认的 WebSecurity</p><p>  ConfigurerAdapter 实例，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootWebSecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultConfigurerAdapter</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  另一个导入的配置类 SecurityDataConfiguration 主要提供了 一个 SecurityEvaluationcontextExtension实例，以便通过SpEL为经过身份验证的用户提供数据查询：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(SecurityEvaluationContextExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityDataConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> SecurityEvaluationContextExtension <span class="title function_">securityEvaluationContextExtension</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecurityEvaluationContextExtension</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  最后一个导入的配置类WebSecurityEnablerConfigination则是我们分析的重点.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = BeanIds.SPRING_SECURITY_FILTER_CHAIN)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityEnablerConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  WebSecurityEnablerConfiguration 配置类中添加了 @EnableWebSecurity 注解，而该注解的 定义，引入了关键的配置类WebSecurityConfiguration。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(value = java.lang.annotation.RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(value = &#123; java.lang.annotation.ElementType.TYPE &#125;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123; WebSecurityConfiguration.class,</span></span><br><span class="line"><span class="meta">		SpringWebMvcImportSelector.class &#125;)</span></span><br><span class="line"><span class="meta">@EnableGlobalAuthentication</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableWebSecurity &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Controls debugging support for Spring Security. Default is false.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> if true, enables debug support with Spring Security</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">debug</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，@EnableWebSecurity是一个组合注解，首先导入了三个配置类：</p><ul><li>WebSecurityConfiguration:用来配置 WebSecurity (重点分析)。</li><li>SpringWebMvcImportSelector:判断当前环境是否存在Spring MVC,如果存在,则引入相关配置。</li><li>OAuth2ImportSelector:判断当前环境是否存在OAuth2,如果存在，则引入相关配置</li></ul><p>另外还有一个@EnableGlobalAuthentication注解，用来开启全局配置，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(value = java.lang.annotation.RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(value = &#123; java.lang.annotation.ElementType.TYPE &#125;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(AuthenticationConfiguration.class)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableGlobalAuthentication &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以看到，@EnableGlobalAuthentication注解的主要功能是导入了配置类AuthenticationConfiguration。</p><p>  从上面的源码中我们可以看到，Spring Security的自动化配置类主要导入了两个类： WebSecurityConfiguration 和 AuthenticationConfiguration 接下来我们就来分析这两个类。</p><h3 id="1-6-1-WebSecurityConfiguration"><a href="#1-6-1-WebSecurityConfiguration" class="headerlink" title="1.6.1 WebSecurityConfiguration"></a>1.6.1 WebSecurityConfiguration</h3><p>  WebSecurityConfiguration配置类的功能，主要就是为了构建Spring Security过滤器链代理对象FilterChainProxy。根据前面的分析，FiIterChainProxy是由Web Security来构建的，所以 在WebSecurityConfiguration中会首先构建WebSecurity对象，再利用WebSecurity对象构建岀 FilterChainProxy。</p><p>  我们先来看一下WebSecurityConfiguration中定义的属性：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> WebSecurity webSecurity;</span><br><span class="line"><span class="keyword">private</span> Boolean debugEnabled;</span><br><span class="line"><span class="keyword">private</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers;</span><br><span class="line"><span class="keyword">private</span> ClassLoader beanClassLoader;</span><br><span class="line"><span class="meta">@Autowired(</span></span><br><span class="line"><span class="meta">    required = false</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectObjectPostProcessor;</span><br></pre></td></tr></table></figure><ul><li>WebSecurityConfiguration 类实现了 ImportAware 接口。ImportAware 接口一般是和 @Import注解一起使用，实现了 ImportAware接口的配置类可以方便地通过setlmportMetadata 方法获取到导入类中的数据配置。换句话说，WebSecurityConfignration实现了 ImportAware接口，使用@Iniport 注解在@EnableWebSecurity 上导入 WebSecurityConfigination 之后，在 WebSecurityConfigination 的 setlmportMetadata 方法中可以方便的获取到@EnableWebSecurity 注解中的属性值，这里主要是debug属性。另一方面，WebSecuityConfiguration类通过实现 BeanClassLoaderAware 接口可以方便地获取到 ClassLoader对象。</li><li>webSecurity 对象是 WebSecurityConfiguration 中需要构建的 WebSecurity 对象。</li><li>webSecurityConfigurers 集合中保存了所有的配置类，也就是 WebSecurityConfignrerAdapter 对象，一个 WebSecurityConfigurerAdapter 对象可以创建一个 httpsSecurity,进而构建出一条过滤器链，多个WebSecurityConfigurerAdapter对象就可以构建出多条过滤器链。</li><li>beanClassLoader 是一个 ClassLoader。</li><li>objectObjectPostProcessor是一个对象后置处理器，注意这个对象是直接从Spring容器中注入的。下一小节会分析对象后置姓理器是什么时候初始化并注册到Sptmg容器中去的，</li></ul><p>这是 WebSecurityConfiguration类中定义的属性。接下来，我们来看一下 setFilterChainProxySecurityConfigurer 方法，该方法主要用来构建一个 WebSecurity 对象，并且加载所有的配置类对象。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFilterChainProxySecurityConfigurer</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor, <span class="meta">@Value(&quot;#&#123;@autowiredWebSecurityConfigurersIgnoreParents.getWebSecurityConfigurers()&#125;&quot;)</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="built_in">this</span>.webSecurity = (WebSecurity)objectPostProcessor.postProcess(<span class="keyword">new</span> <span class="title class_">WebSecurity</span>(objectPostProcessor));</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.debugEnabled != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.webSecurity.debug(<span class="built_in">this</span>.debugEnabled);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    webSecurityConfigurers.sort(WebSecurityConfiguration.AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">previousOrder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">previousConfig</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    Iterator var5;</span><br><span class="line">    SecurityConfigurer config;</span><br><span class="line">    <span class="keyword">for</span>(var5 = webSecurityConfigurers.iterator(); var5.hasNext(); previousConfig = config) &#123;</span><br><span class="line">        config = (SecurityConfigurer)var5.next();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">order</span> <span class="operator">=</span> WebSecurityConfiguration.AnnotationAwareOrderComparator.lookupOrder(config);</span><br><span class="line">        <span class="keyword">if</span> (previousOrder != <span class="literal">null</span> &amp;&amp; previousOrder.equals(order)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;@Order on WebSecurityConfigurers must be unique. Order of &quot;</span> + order + <span class="string">&quot; was already used on &quot;</span> + previousConfig + <span class="string">&quot;, so it cannot be used on &quot;</span> + config + <span class="string">&quot; too.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        previousOrder = order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var5 = webSecurityConfigurers.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">        config = (SecurityConfigurer)var5.next();</span><br><span class="line">        <span class="built_in">this</span>.webSecurity.apply(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.webSecurityConfigurers = webSecurityConfigurers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  setFilterChainProxySecurityConfigurer 方法有两个参数，第一个参数 objectPostProcessor 是一个对象后置处理器，由于该方法有一个@Autowired注解，会自动查找需要注入的参数，所以objectPostProcessor参数会自动注入进来。需要注意的是，@Autowired注解的required属性为false,所以在方法参数注入的时候，有就注入，没有则忽略。required属性设置为false主要是针对第二个参数webSecurityConfigurers ,因为该参数的值是通过调用 autowiredWebSecurityConfigurersIgnoreParents 对象的 getWebSecurityConfigurers 方法获取的。 autowiredWebSecurityConfigurersIgnoreParents 对象也是在当前类中注入到 Spring 容器中的，我们来看一下它的 getWebSecurityConfigurers 方法:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; <span class="title function_">getWebSecurityConfigurers</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    Map&lt;String, WebSecurityConfigurer&gt; beansOfType = <span class="built_in">this</span>.beanFactory.getBeansOfType(WebSecurityConfigurer.class);</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> beansOfType.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">        Entry&lt;String, WebSecurityConfigurer&gt; entry = (Entry)var3.next();</span><br><span class="line">        webSecurityConfigurers.add(entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> webSecurityConfigurers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以看到，在 getWebSecurityConfigurers方法中主要是通过调用 beanFactory.getBeansOfType 方法来获取 Spring 容器中所有的 WebSecurityConfigurer 实例，也就是开发者自定义的各种各样继承自WebSecurityConfigurerAdapter的配置类。如果开发者没有自定义任何配置类，那么这里获取到的就是前面所讲的SprmgBootWebSecurityConfiguration 类中提供的默认配置类，将获取到的所有配置类实例放入webSecurityConfigurers集合中并返回。</p><p>  返回setFilterChainProxySecurityConfigurer方法中，现在我们已经明白了第二个参数 webSecurityConfigruers的含义了，在该方法中，首先创建一个WebSecurity实例，创建出来之后去对象后置处理器中走一圈，这样就将webSecurity对象注册到Spring容器中了。接下来， 根据每一个配置类的@Order注解对webSecurityConfigurers集合中的所有配置类进行排序，因 为一个配置类对应一个过滤器链，当请求到来后，需要先和哪个过滤器链进行匹配，这里必然存在一个优先级问题，所以如果开发者自定义了多个配置类，则需要通过@Order注解标记 多个配置类的优先级。排序完成后，进入到for循环中，检查是否存在优先级相等的配置类， 如果存在，则直接抛出异常。最后再去遍历所有的配置类，调用webSecurity.apply方法将其添加到webSecurity父类中的configurers集合中(将来遍历该集合并分别调用配置类的init和configure方法完成配置类的初始化操作)。</p><p>  这是setFiltetChainProxySecurityConfigurer方法的执行逻辑，该方法主要用来初始化 WebSecurity对象，同时收集到所有的自定义配置类。</p><p>  有了 WebSecurity对象和配置类，接下来就可以构建过滤器FilterChainProxy 了。我们来看一下 springSecurityFilterChain 方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Filter <span class="title function_">springSecurityFilterChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasConfigurers</span> <span class="operator">=</span> <span class="built_in">this</span>.webSecurityConfigurers != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.webSecurityConfigurers.isEmpty();</span><br><span class="line">    <span class="keyword">if</span> (!hasConfigurers) &#123;</span><br><span class="line">        <span class="type">WebSecurityConfigurerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> (WebSecurityConfigurerAdapter)<span class="built_in">this</span>.objectObjectPostProcessor.postProcess(<span class="keyword">new</span> <span class="title class_">WebSecurityConfigurerAdapter</span>() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">this</span>.webSecurity.apply(adapter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (Filter)<span class="built_in">this</span>.webSecurity.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  这里首先判断webSecurityConfigurers集合中是否存在配置类，如果不存在，则立马创建 一个匿名的 WebSecurityConfigurerAdapter对象并注册到Spring容器中，否则就直接调用 WebSecurity的build方法进行构建。</p><p>  根据前面小节的介绍，了解了 WebSecurity对象的build方法执行后，首先会对所有的配置类即 WebSecurityConfigurerAdapter 实例进行构建，在 WebSecurityConfigurerAdapter 的 init 方法中，又会完成httpsSecurity的构建，而httpsSecurity的构建过程中，则会完成局部 AuthenticationManager对象以及每一个具体的过滤器的构建。</p><p>  这就是整个过滤器链的构建流程。</p><h3 id="1-6-2-Authenticationconfiguration"><a href="#1-6-2-Authenticationconfiguration" class="headerlink" title="1.6.2 Authenticationconfiguration"></a>1.6.2 Authenticationconfiguration</h3><p>在Spring Security自动化配置类中导入的另外一个配置类是Authenticationconfiguration, 该类的功能主要是做全局的配置，同时提供-个全局的AuthenticationManager实例。首先我们来看 AuthenticationConfiguration 类的定义：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(</span></span><br><span class="line"><span class="meta">    proxyBeanMethods = false</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@Import(&#123;ObjectPostProcessorConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationConfiguration</span></span><br></pre></td></tr></table></figure><p>  可以看到，AuthenticationConfiguration 类的定义中，导入了ObjectPostProcessorConfiguration配置，而ObjectPostProcessorConfiguration配置则提供了一个基本的对象后置处理器：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(</span></span><br><span class="line"><span class="meta">    proxyBeanMethods = false</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@Role(2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectPostProcessorConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ObjectPostProcessorConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Role(2)</span></span><br><span class="line">    <span class="keyword">public</span> ObjectPostProcessor&lt;Object&gt; <span class="title function_">objectPostProcessor</span><span class="params">(AutowireCapableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutowireBeanFactoryObjectPostProcessor</span>(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以看到，ObjectPostProcessorConfiguration 类主要提供了一个 ObjectPostProcessor 实例， 具体的实现类是AutowireBeanFactoiyObjectPostProcessor,根据前面的介绍，该实现类主要用来将一个对象注册到Spring容器中去，我们在其他配置类中所见到的ObjectPostProcessor 实例其实都是这里提供的。</p><p>  这是 AuthenticationConfiguration 类的定义部分，AuthenticationConfigiuation 类中的方法比较多，我们挑选出关键的部分分析一下：</p><p>查看代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationManagerBuilder <span class="title function_">authenticationManagerBuilder</span><span class="params">(ObjectPostProcessor&lt;Object&gt; objectPostProcessor, ApplicationContext context)</span> &#123;</span><br><span class="line">    AuthenticationConfiguration.<span class="type">LazyPasswordEncoder</span> <span class="variable">defaultPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticationConfiguration</span>.LazyPasswordEncoder(context);</span><br><span class="line">    <span class="type">AuthenticationEventPublisher</span> <span class="variable">authenticationEventPublisher</span> <span class="operator">=</span> (AuthenticationEventPublisher)getBeanOrNull(context, AuthenticationEventPublisher.class);</span><br><span class="line">    AuthenticationConfiguration.<span class="type">DefaultPasswordEncoderAuthenticationManagerBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticationConfiguration</span>.DefaultPasswordEncoderAuthenticationManagerBuilder(objectPostProcessor, defaultPasswordEncoder);</span><br><span class="line">    <span class="keyword">if</span> (authenticationEventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">        result.authenticationEventPublisher(authenticationEventPublisher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> GlobalAuthenticationConfigurerAdapter <span class="title function_">enableGlobalAuthenticationAutowiredConfigurer</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthenticationConfiguration</span>.EnableGlobalAuthenticationAutowiredConfigurer(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> InitializeUserDetailsBeanManagerConfigurer <span class="title function_">initializeUserDetailsBeanManagerConfigurer</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InitializeUserDetailsBeanManagerConfigurer</span>(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> InitializeAuthenticationProviderBeanManagerConfigurer <span class="title function_">initializeAuthenticationProviderBeanManagerConfigurer</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InitializeAuthenticationProviderBeanManagerConfigurer</span>(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> AuthenticationManager <span class="title function_">getAuthenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.authenticationManagerInitialized) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authenticationManager;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">AuthenticationManagerBuilder</span> <span class="variable">authBuilder</span> <span class="operator">=</span> (AuthenticationManagerBuilder)<span class="built_in">this</span>.applicationContext.getBean(AuthenticationManagerBuilder.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.buildingAuthenticationManager.getAndSet(<span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthenticationConfiguration</span>.AuthenticationManagerDelegator(authBuilder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="built_in">this</span>.globalAuthConfigurers.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">                <span class="type">GlobalAuthenticationConfigurerAdapter</span> <span class="variable">config</span> <span class="operator">=</span> (GlobalAuthenticationConfigurerAdapter)var2.next();</span><br><span class="line">                authBuilder.apply(config);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="built_in">this</span>.authenticationManager = (AuthenticationManager)authBuilder.build();</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.authenticationManager == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.authenticationManager = <span class="built_in">this</span>.getAuthenticationManagerBean();</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="built_in">this</span>.authenticationManagerInitialized = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.authenticationManager;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先定义了一个AuthenticationManagerBuilder实例，目的是为了构建全局的 AuthenticationManager 对象，这个过程中会从 Spring 容器中査找 AuthenticationEventPublisher 实例设置给 AuthenticationManagerBuilder 对象。</p><ul><li>接下来构建了三个Bean,这三个Bean的作用在前面小节中已经介绍过了，这里就不再赘述了.</li><li>getAuthenticationManager 方法则用来构建具体的 AuthenticationManager 对象，在该方法内部，会首先判断AuthenticationManager对象是否已经初始化，如果已经初始化，则直接 返回 AuthenticationManager 对象，否则就先从 Spring 容器中获取到 AuthenticationManagerBuilder对象。注意这里还多了一个AuthenticationManagerDelegator对象，这个主要是为了防止在初始化AuthenticationManager时进行无限递归，拿到authBuilder对象之后，接下来遍历 globalAuthConfigurers配置类集合(也就是第二点中所说的三个配置类)，将配置类分别添加到authBuilder对象中，然后进行构建，最终将构建结果返回。</li></ul><p>这是全局AuthenticationManager的构建过程。</p><p>整体来说，AuthenticationConfiguration的作用主要体现在两方面：第一就是导入了 ObjectPostProcessorConfiguration 配置类；第二则是提供 了一个全局的 AuthenticationManager 对象。</p><p>如果升发者在自定义配置类中重写了 configure(AuthenticationManagerBuilder)方法，这里的全局AuthenticationManager对象将不会生效，而大部分情况下，开发者都会重写 configure(AuthenticationManagerBuilder)方法。</p><p>至此，Spring Security初始化就讲解完了。然而这里的架构复杂，概念繁多，可能有读者看完之后还是理解不到位，因此，接下来我们将通过几个不同的案例，展示前面这些组件的不同用法，加深大家对Spring Security基础组件的理解。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="http://blog.buretuzi.online">李文若</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://blog.buretuzi.online/2022/08/07/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89/">http://blog.buretuzi.online/2022/08/07/Spring%20Security%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%888%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://blog.buretuzi.online" target="_blank">清河水温龙井茶</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Security/">Spring Security</a></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_wechat"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_facebook_messenger"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/09/ObjectPostProcessor%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%A4%9A%E7%A7%8D%E7%94%A8%E6%88%B7%E5%AE%9A%E4%B9%89%E6%96%B9%E5%BC%8F%EF%BC%889%EF%BC%89/"><img class="prev-cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-w8dv76.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ObjectPostProcessor使用与多种用户定义方式（9）</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/04/Spring%20Security%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90%E5%B9%B6%E6%B7%BB%E5%8A%A0%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E7%A0%81%EF%BC%887%EF%BC%89/"><img class="next-cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-exy8kk.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring Security配置多个数据源并添加登录验证码（7）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/08/09/ObjectPostProcessor%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%A4%9A%E7%A7%8D%E7%94%A8%E6%88%B7%E5%AE%9A%E4%B9%89%E6%96%B9%E5%BC%8F%EF%BC%889%EF%BC%89/" title="ObjectPostProcessor使用与多种用户定义方式（9）"><img class="cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-w8dv76.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-09</div><div class="title">ObjectPostProcessor使用与多种用户定义方式（9）</div></div></a></div><div><a href="/2022/08/02/Spring%20Security%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%81%EF%BC%882%EF%BC%89/" title="Spring Security基本认证（2）"><img class="cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-g8e18q.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-02</div><div class="title">Spring Security基本认证（2）</div></div></a></div><div><a href="/2022/08/10/Spring%20Security%E5%AE%9A%E4%B9%89%E5%A4%9A%E4%B8%AA%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%EF%BC%8810%EF%BC%89/" title="Spring Security定义多个过滤器链（10）"><img class="cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-gpj1pl.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-10</div><div class="title">Spring Security定义多个过滤器链（10）</div></div></a></div><div><a href="/2022/08/03/Spring%20Security%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%EF%BC%884%EF%BC%89/" title="Spring Security登录用户数据获取（4）"><img class="cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-j8qjpq.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-03</div><div class="title">Spring Security登录用户数据获取（4）</div></div></a></div><div><a href="/2022/08/02/Spring%20Security%E7%99%BB%E5%BD%95%E8%A1%A8%E5%8D%95%E9%85%8D%E7%BD%AE%EF%BC%883%EF%BC%89/" title="Spring Security登录表单配置（3）"><img class="cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-j8wljy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-02</div><div class="title">Spring Security登录表单配置（3）</div></div></a></div><div><a href="/2022/08/01/Spring%20Security%E7%9A%84%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83%EF%BC%881%EF%BC%89/" title="Spring Security的认证和授权（1）"><img class="cover" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-k7g9qq.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-01</div><div class="title">Spring Security的认证和授权（1）</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div id="comment-switch"><span class="first-comment">Twikoo</span><span class="switch-btn"></span><span class="second-comment">Valine</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">李文若</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">48</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/luaby"><i class="fab fa-github"></i><span>My GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/luaby" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:liwenruo87@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Doro喜欢吃 欧润吉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">过滤器链分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">1. 初始化流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-ObjectPostProcessor"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 ObjectPostProcessor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-SecurityFilterChain"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 SecurityFilterChain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-SecurityBuilder"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 SecurityBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-FilterChainProxy"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 FilterChainProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-SecurityConfigurer"><span class="toc-number">2.5.</span> <span class="toc-text">1.5 SecurityConfigurer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.6.</span> <span class="toc-text">1.6 初始化流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-1-WebSecurityConfiguration"><span class="toc-number">2.6.1.</span> <span class="toc-text">1.6.1 WebSecurityConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-2-Authenticationconfiguration"><span class="toc-number">2.6.2.</span> <span class="toc-text">1.6.2 Authenticationconfiguration</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/05/13/exe%E6%B3%A8%E5%86%8C%E4%B8%BAwindows%E6%9C%8D%E5%8A%A1/" title="exe注册为windows服务"><img src="https://image.buretuzi.online/blog/article/article-background/wallhaven-2yed86.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="exe注册为windows服务"></a><div class="content"><a class="title" href="/2025/05/13/exe%E6%B3%A8%E5%86%8C%E4%B8%BAwindows%E6%9C%8D%E5%8A%A1/" title="exe注册为windows服务">exe注册为windows服务</a><time datetime="2025-05-13T17:06:18.000Z" title="发表于 2025-05-13 17:06:18">2025-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/13/UE4_2_operation/" title="2.UE4物体移动"><img src="https://image.buretuzi.online/ue4/095223-6245095744c07.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="2.UE4物体移动"></a><div class="content"><a class="title" href="/2025/04/13/UE4_2_operation/" title="2.UE4物体移动">2.UE4物体移动</a><time datetime="2025-04-13T10:16:00.000Z" title="发表于 2025-04-13 10:16:00">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/11/UE4_1_operation/" title="1.UE4基础操作"><img src="https://image.buretuzi.online/ue4/095223-6245095744c07.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="1.UE4基础操作"></a><div class="content"><a class="title" href="/2025/04/11/UE4_1_operation/" title="1.UE4基础操作">1.UE4基础操作</a><time datetime="2025-04-11T22:16:00.000Z" title="发表于 2025-04-11 22:16:00">2025-04-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/10/Linux%20%E6%90%AD%E5%BB%BAKMS/" title="Linux 搭建KMS"><img src="https://image.buretuzi.online/blog/article/article-background/wallhaven-x61vml.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Linux 搭建KMS"></a><div class="content"><a class="title" href="/2023/11/10/Linux%20%E6%90%AD%E5%BB%BAKMS/" title="Linux 搭建KMS">Linux 搭建KMS</a><time datetime="2023-11-10T10:43:12.000Z" title="发表于 2023-11-10 10:43:12">2023-11-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/10/Linux%20%E6%90%AD%E5%BB%BAOpenVPN/" title="Linux 搭建OpenVPN"><img src="https://image.buretuzi.online/blog/article/article-background/wallhaven-x61vml.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Linux 搭建OpenVPN"></a><div class="content"><a class="title" href="/2023/11/10/Linux%20%E6%90%AD%E5%BB%BAOpenVPN/" title="Linux 搭建OpenVPN">Linux 搭建OpenVPN</a><time datetime="2023-11-10T10:43:12.000Z" title="发表于 2023-11-10 10:43:12">2023-11-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer_deal"><a class="deal_link" href="" title="mail"><i class="iconfont icon-17"></i></a><a class="deal_link" href="" title="qq" target="_blank"><i class="iconfont icon-qq"></i></a><a class="deal_link" href="" title="CSDN" target="_blank"><i class="iconfont icon-csdn"></i></a><a class="deal_link" href="https://github.com/luaby" title="github" target="_blank"><i class="iconfont icon-github"></i></a><img class="footer_mini_logo entered loading" style="border-radius:50%" src="/img/彩虹.png" onclick="btf.scrollToDest(0,500)" title="返回顶部"><a class="deal_link" href="" title="QQ空间"><i class="iconfont icon-qzone"></i></a><a class="deal_link" href="" title="微信" target="_blank"><i class="iconfont icon-wechat"></i></a><a class="deal_link" href="" title="Twitter" target="_blank"><i class="iconfont icon-twitter"></i></a><a class="deal_link" href="" title="Telegram" target="_blank"><i class="iconfont icon-fasong"></i></a></div><div id="Jay-footer"><div class="footer-group"><h3 class="footer-title">直达</h3><div class="footer-links"><a class="footer-item" href="" target="_blank">我的主页</a><a class="footer-item" href="">音乐欣赏</a><a class="footer-item" href="">心灵港湾</a><a class="footer-item" href="">随机文章</a></div></div><div class="footer-group"><h3 class="footer-title">分类</h3><div class="footer-links"><a class="footer-item" href="">学习笔记</a><a class="footer-item" href="">魔改教程</a><a class="footer-item" href="">算法笔记</a><a class="footer-item" href="">语法教程</a></div></div><div class="footer-group"><h3 class="footer-title">关于</h3><div class="footer-links"><a class="footer-item" href="/about/">关于我</a><a class="footer-item" href="">博客统计</a><a class="footer-item" href="/archives/">文章归档</a><a class="footer-item" href="">更新记录</a></div></div><div class="footer-group"><h3 class="footer-title">友链</h3><div class="footer-links" id="friend-links-in-footer"><a class="footer-item" target="_blank" rel="noopener" href="https://anzhiy.cn/">安知鱼</a><a class="footer-item" target="_blank" rel="noopener" href="https://www.chuckle.top">轻笑Chuckle</a><a class="footer-item" target="_blank" rel="noopener" href="https://akilar.top/">Akilarの糖果屋</a><a class="footer-item" target="_blank" rel="noopener" href="https://yisous.xyz">Ariasaka</a></div></div><div class="footer-group"><h3 class="footer-title">协议</h3><div class="footer-links"><a class="footer-item" href="">隐私协议</a><a class="footer-item" href="">Cookie</a><a class="footer-item" href="">版权协议</a></div></div></div><!--#footer-banner--><!--        #footer-banner-tips--><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="nav-music"><div id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()">播放音乐</div><meting-js id="8703296584" server="tencent" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="iconfont icon-baidu"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-music"><a class="rightMenu-item" id="menu-music-play" href="javascript:anzhiyu.musicToggle()"><i class="fas fa-play"></i><span>播放音乐</span></a><a class="rightMenu-item" id="menu-music-pause" href="javascript:anzhiyu.musicToggle()"><i class="fa-solid fa-pause"></i><span>暂停音乐</span></a><a class="rightMenu-item" href="javascript:anzhiyu.musicSkipBack()"><i class="fas fa-backward"></i><span>切换到上一首</span></a><a class="rightMenu-item" href="javascript:anzhiyu.musicSkipForward()"><i class="fas fa-forward"></i><span>切换到下一首</span></a><a class="rightMenu-item" target="_blank" rel="noopener" href="https://y.qq.com/n/ryqq/playlist/8703296584"><i class="fas fa-radio"></i><span>查看歌单</span></a><a class="rightMenu-item" href="javascript:anzhiyu.musicGetSingName()"><i class="fas fa-copy"></i><span>复制歌名</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="./#post-comment"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.click()"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line" id="common"><a class="rightMenu-item" href="javascript:toRandomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.translate();"><i class="iconfont icon-fanti"></i><span>繁简转换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="javascript:window.location.href=&quot;/about/&quot;;"><i class="fa fa-info-circle"></i><span>版权声明</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/pluginsSrc/instant.page/instantpage.js" type="module"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/pluginsSrc/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.buretuzi.online/",region:"",onCommentLoaded:function(){btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null))},t=()=>{"object"!=typeof twikoo?getScript("/pluginsSrc/twikoo/dist/twikoo.all.min.js").then(o):setTimeout(o,0)};t()})()</script><script>function loadValine(){function n(){new Valine(Object.assign({el:"#vcomment",appId:"0onZJ2E9cHeXWot3kJWDdrfM-gzGzoHsz",appKey:"ghd4PqqDJfdNbcH3JZEGwl4A",avatar:"mp",serverURLs:"",emojiMaps:"",path:window.location.pathname,visitor:!0}))}"function"==typeof Valine?n():getScript("/pluginsSrc/valine/dist/Valine.min.js").then(n)}{function loadOtherComment(){loadValine()}setTimeout(loadValine,0)}</script></div><div class="aplayer no-destroy" data-id="1708664797" data-server="tencent" data-type="playlist" data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true"></div><script src="/js/cursor.js"></script><script src="/js/sakura.js"></script><script src="/js/Progressbar.js"></script><script async data-pjax src="/js/navigation.js"></script><script src="/js/jquery.min.js"></script><script src="/js/rightmenu.js"></script><script src="/js/title.js"></script><script src="/js/player/anzhiyu.js"></script><script src="/js/player/anzhiyufunction.js"></script><script src="/js/winbox.bundle.min.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="/pluginsSrc/butterfly-extsrc/dist/fireworks.min.js"></script><script defer id="fluttering_ribbon" mobile="true" src="/pluginsSrc/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="/pluginsSrc/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="/css/player/APlayer.min.css" media="print" onload='this.media="all"'><script src="/js/player/APlayer.min.js"></script><script src="/js/player/Meting2.min.js"></script><script src="/pluginsSrc/pjax/pjax.min.js"></script><script>let pjaxSelectors=["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.tocScrollFn&&window.removeEventListener("scroll",window.tocScrollFn),window.scrollCollect&&window.removeEventListener("scroll",scrollCollect),document.getElementById("rightside").style.cssText="opacity: ''; transform: ''",window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode"),"object"==typeof disqusjs&&disqusjs.destroy()})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script></div><div class="contact-info"><div class="option"><i class="fas fa-heart"></i><div class="bloktop"></div><div class="text">或许不该心动<div class="strip"></div></div></div><div class="option"><i class="fas fa-commenting"></i><div class="blok"></div><div class="text">要和我说悄悄话吗？<div class="strip"></div></div></div><div class="option"><i class="fas fa-hourglass-2"></i><div class="blokbottom"></div><div class="text">人生匆匆，何必拘泥过往<div class="strip"></div></div></div></div><script data-pjax>function butterfly_categories_card_injector_config(){var a=document.getElementById("recent-posts");console.log("已挂载butterfly_categories_card"),a.insertAdjacentHTML("afterbegin",'<style>li.categoryBar-list-item{width:24%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(/img/1.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/java/&quot;);" href="javascript:void(0);">java</a><span class="categoryBar-list-count">41</span><span class="categoryBar-list-descr">技术</span></li><li class="categoryBar-list-item" style="background:url(/img/2.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/windows/&quot;);" href="javascript:void(0);">windows</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(/img/3.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Linux/&quot;);" href="javascript:void(0);">Linux</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(/img/4.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/UE4/&quot;);" href="javascript:void(0);">UE4</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li></ul></div></div>')}document.getElementById("recent-posts")&&"/"===location.pathname&&butterfly_categories_card_injector_config()</script><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var e=document.getElementById("card-widget");console.log("已挂载butterfly_clock_anzhiyu"),e&&e.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/img/clock.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",qweather_key="077e8d0195484e3a81fdbc5082aab008",gaud_map_key="af81a9f393f79a52e1deb75a2109d705",baidu_ak_key="undefined",flag=0,clock_rectangle="112.982279,28.19409",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_clock_anzhiyu_injector_config()</script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="/js/clock.min.js"></script><script data-pjax>function butterfly_footer_beautify_injector_config(){var t=document.getElementById("footer-wrap");console.log("已挂载butterfly_footer_beautify"),t.insertAdjacentHTML("beforeend",'<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="/img/footer/frame.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.2.2" title=""><img src="/img/footer/theme.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com" style="margin-inline:5px" data-title="本站使用Vercel作为静态托管平台" title=""><img src="/img/footer/host.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20229936" style="margin-inline:5px" data-title="本站已在萌进行备案" title=""><img src="/img/footer/萌备案.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn" style="margin-inline:5px" data-title="本站已在豫进行备案" title=""><img src="/img/footer/豫备案.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/" style="margin-inline:5px" data-title="本站使用又拍云为静态资源提供CDN加速" title=""><img src="/img/footer/cdn.svg" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="/img/footer/copyright.svg" alt=""/></a></p>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_footer_beautify_injector_config()</script><script data-pjax>function butterfly_swiper_injector_config(){var i=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),i.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/07/17/异常处理- SpringBoot（11）/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://image.buretuzi.online/blog/article/article-background/wallhaven-3zj6l9.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-07-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/07/17/异常处理- SpringBoot（11）/&quot;);" href="javascript:void(0);" alt="">异常处理- SpringBoot（11）</a><div class="blog-slider__text">你会爱我吗？</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/07/17/异常处理- SpringBoot（11）/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/08/18/java垃圾收集器与内存分配策略(2)/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="/img/1.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/08/18/java垃圾收集器与内存分配策略(2)/&quot;);" href="javascript:void(0);" alt="">java垃圾收集器与内存分配策略(2)</a><div class="blog-slider__text">好吧就这样吧</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/08/18/java垃圾收集器与内存分配策略(2)/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="/",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer src="/js/swiper/swiper.min.js"></script><script defer data-pjax src="/js/swiper/swiper_init.js"></script></body></html>